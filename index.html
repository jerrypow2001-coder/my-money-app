<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Aurora Assets</title>
    
    <meta name="theme-color" content="#0B0C15">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aurora">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- SCROLLING FIXES --- */
        html {
            height: 100%;
            /* Prevent rubber-banding on iOS if desired, but allow scrolling */
            overscroll-behavior-y: none; 
        }
        body { 
            /* FIXED: Changed from overflow-hidden to auto */
            overflow-y: auto; 
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Outfit', sans-serif;
            background-color: #0B0C15;
        }

        /* Hide scrollbar for clean UI but keep functionality */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        input, select { font-size: 16px !important; } /* Stop iOS Zoom */
        
        /* Animations */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 2s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "@google/generative-ai": "https://esm.sh/@google/generative-ai"
        }
    }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { 
            Plus, Trash2, Wallet, TrendingUp, RefreshCw, Sun, Moon, Settings, Key, 
            Download, Upload, PieChart, Briefcase, Landmark, Sparkles, ChevronLeft, ChevronRight,
            ShieldCheck, ShieldAlert, X
        } from 'lucide-react';

        const App = () => {
            // --- STATE ---
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [activeTab, setActiveTab] = useState('accounts'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('ledger'); 
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null); 
            const fileInputRef = useRef(null);
            
            // --- DATA ---
            const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-ledger-pro')) || []; } catch { return []; } });
            const [stocks, setStocks] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-stocks-pro')) || []; } catch { return []; } });
            const [accounts, setAccounts] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-accounts-pro')) || []; } catch { return []; } });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('aurora-api-key') || ''); 
            
            const [currentLedgerDate, setCurrentLedgerDate] = useState(new Date());
            const [chartType, setChartType] = useState('expense'); 
            
            // AI
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [keyStatus, setKeyStatus] = useState('none');
            const [isUpdatingPrices, setIsUpdatingPrices] = useState(false);

            // PERSISTENCE
            useEffect(() => { localStorage.setItem('aurora-ledger-pro', JSON.stringify(transactions)); }, [transactions]);
            useEffect(() => { localStorage.setItem('aurora-stocks-pro', JSON.stringify(stocks)); }, [stocks]);
            useEffect(() => { localStorage.setItem('aurora-accounts-pro', JSON.stringify(accounts)); }, [accounts]);
            useEffect(() => { localStorage.setItem('aurora-api-key', apiKey); }, [apiKey]);

            // THEME
            const THEME = isDarkMode ? {
                bg: "bg-[#0B0C15]", 
                glassCard: "bg-[#1A1D2D]/80 backdrop-blur-md border border-white/[0.08] shadow-xl",
                glassNav: "bg-[#161822]/95 backdrop-blur-xl border-t border-white/[0.08]",
                textMain: "text-white",
                textMuted: "text-white/40",
                inputBg: "bg-black/20",
                accentGradient: "from-emerald-400 to-teal-500",
                navIconActive: "text-emerald-300",
                navIconInactive: "text-gray-500",
            } : {
                bg: "bg-slate-100", 
                glassCard: "bg-white shadow-lg border border-slate-200",
                glassNav: "bg-white/95 backdrop-blur-xl border-t border-slate-200",
                textMain: "text-slate-800",
                textMuted: "text-slate-500",
                inputBg: "bg-slate-50",
                accentGradient: "from-emerald-500 to-teal-600",
                navIconActive: "text-emerald-600",
                navIconInactive: "text-slate-400",
            };

            const formatMoney = (n) => new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR', minimumFractionDigits: 2 }).format(n || 0);

            const CATEGORIES = {
                expense: [
                    { name: 'Food', icon: 'üçú' }, { name: 'Grocery', icon: 'ü•¶' }, { name: 'Transport', icon: 'üöó' }, 
                    { name: 'Shopping', icon: 'üõçÔ∏è' }, { name: 'Rent', icon: 'üè†' }, { name: 'Utilities', icon: '‚ö°' }, 
                    { name: 'Travel', icon: '‚úàÔ∏è' }, { name: 'Health', icon: 'üíä' }
                ],
                income: [
                    { name: 'Salary', icon: 'üíº' }, { name: 'Refund', icon: '‚Ü©Ô∏è' }, { name: 'Invest', icon: 'üìà' }, 
                    { name: 'Gift', icon: 'üéÅ' }
                ]
            };

            // --- CALCULATIONS ---
            const filteredTransactions = useMemo(() => transactions.filter(t => {
                const parts = t.date.split('/');
                if (parts.length !== 3) return false;
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                return month - 1 === currentLedgerDate.getMonth() && year === currentLedgerDate.getFullYear();
            }).sort((a,b) => b.timestamp - a.timestamp), [transactions, currentLedgerDate]);

            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((a,c) => a + c.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((a,c) => a + c.amount, 0);
            const stockVal = stocks.reduce((a,c) => a + (c.currentPrice * c.shares), 0);
            const cashVal = accounts.reduce((a,c) => a + c.balance, 0);
            const netWorth = cashVal + stockVal;

            const analyticsData = useMemo(() => {
                const map = {};
                filteredTransactions.filter(t => t.type === chartType).forEach(t => {
                    const n = t.cat?.name || 'Other';
                    map[n] = (map[n] || 0) + t.amount;
                });
                return Object.entries(map).sort((a,b) => b[1] - a[1]);
            }, [filteredTransactions, chartType]);

            // --- FORM STATE ---
            const [form, setForm] = useState({});

            // --- ACTIONS ---
            const saveTx = () => {
                if(!form.amount) return;
                const d = form.date ? new Date(form.date) : new Date();
                const formatted = d.toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'numeric'});
                const val = parseFloat(form.amount);

                if (!form.id && form.accId) {
                    const acc = accounts.find(a => a.id == form.accId);
                    if(acc) {
                        const newBal = form.type === 'income' ? acc.balance + val : acc.balance - val;
                        setAccounts(accounts.map(a => a.id === acc.id ? {...a, balance: newBal} : a));
                    }
                }

                const newTx = { 
                    id: form.id || Date.now(), 
                    type: form.type || 'expense', 
                    amount: val, 
                    cat: form.cat || CATEGORIES.expense[0], 
                    note: form.note || '', 
                    date: formatted, 
                    timestamp: d.getTime(), 
                    accountId: form.accId 
                };

                setTransactions(prev => form.id ? prev.map(t => t.id===form.id?newTx:t) : [newTx, ...prev]);
                setIsModalOpen(false);
            };

            const saveAcc = () => {
                if(!form.name) return;
                const newAcc = { id: form.id || Date.now(), name: form.name, type: form.accType || 'bank', balance: parseFloat(form.balance)||0, interestRate: parseFloat(form.interest)||0, icon: 'üè¶' };
                setAccounts(prev => form.id ? prev.map(a => a.id===form.id?newAcc:a) : [...prev, newAcc]);
                setIsModalOpen(false);
            };

            const saveStock = () => {
                if(!form.symbol) return;
                const newStock = { id: form.id || Date.now(), name: form.name||form.symbol, symbol: form.symbol, shares: parseFloat(form.shares)||0, avgCost: parseFloat(form.cost)||0, currentPrice: parseFloat(form.price)||parseFloat(form.cost)||0 };
                setStocks(prev => form.id ? prev.map(s => s.id===form.id?newStock:s) : [...prev, newStock]);
                setIsModalOpen(false);
            };

            const confirmDelete = () => {
                if(!deleteTarget) return;
                if(deleteTarget.type === 'tx') setTransactions(t => t.filter(x => x.id !== deleteTarget.id));
                if(deleteTarget.type === 'acc') setAccounts(t => t.filter(x => x.id !== deleteTarget.id));
                if(deleteTarget.type === 'stock') setStocks(t => t.filter(x => x.id !== deleteTarget.id));
                setDeleteTarget(null); setIsModalOpen(false);
            };

            // --- AI & API ---
            const verifyKey = async () => {
                if(!apiKey) return;
                setKeyStatus('verifying');
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                    await model.generateContent("Test");
                    setKeyStatus('valid');
                } catch { setKeyStatus('invalid'); }
            };

            const updatePrices = async () => {
                if(!apiKey) return setShowSettingsModal(true);
                setIsUpdatingPrices(true);
                const symbols = stocks.map(s => s.symbol);
                if(symbols.length === 0) { setIsUpdatingPrices(false); return alert("No stocks."); }

                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                    const prompt = `Return a JSON object of approximate current prices for: ${symbols.join(',')}. Keys=Symbols, Values=Numbers. Malysian stocks (.KL) in MYR. Example: {"AAPL":150, "1155.KL":8.50}`;
                    const res = await model.generateContent(prompt);
                    const text = res.response.text().replace(/```json|```/g, '').trim();
                    const prices = JSON.parse(text);
                    setStocks(stocks.map(s => prices[s.symbol] ? {...s, currentPrice: prices[s.symbol]} : s));
                    alert("Prices updated.");
                } catch (e) { alert("Update failed."); }
                setIsUpdatingPrices(false);
            };

            const getInsight = async () => {
                if(!apiKey) return setShowSettingsModal(true);
                setIsAiLoading(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                    const prompt = `Act as a financial advisor. Net Worth: ${netWorth}. Cash: ${cashVal}. Stocks: ${stockVal}. Monthly Exp: ${totalExpense}. Give 3 short bullet points advice.`;
                    const res = await model.generateContent(prompt);
                    setAiAnalysis(res.response.text());
                } catch { setAiAnalysis("Error generating insight."); }
                setIsAiLoading(false);
            };

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify({transactions, accounts, stocks, apiKey})], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'aurora_backup.json'; a.click();
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(confirm("Overwrite data?")) {
                            if(d.transactions) setTransactions(d.transactions);
                            if(d.accounts) setAccounts(d.accounts);
                            if(d.stocks) setStocks(d.stocks);
                            if(d.apiKey) setApiKey(d.apiKey);
                            alert("Restored.");
                        }
                    } catch { alert("Invalid file."); }
                };
                reader.readAsText(file);
            };

            // --- RENDER ---
            return (
                <div className={`min-h-screen ${THEME.bg} ${THEME.textMain} transition-colors duration-300 pb-32`}>
                    {/* Background Blobs - FIXED POSITION so they don't break scroll */}
                    <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                        <div className="absolute top-[-10%] left-[-10%] w-64 h-64 bg-emerald-500/10 rounded-full blur-[100px] animate-blob"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-64 h-64 bg-blue-500/10 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
                    </div>

                    {/* Header */}
                    <div className="relative z-10 p-6 pt-10">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <div className={`text-xs font-bold uppercase tracking-widest ${THEME.textMuted}`}>Net Worth</div>
                                <div className="text-4xl font-bold mt-1">{formatMoney(netWorth)}</div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${isDarkMode?'bg-white/10':'bg-slate-200'}`}>{isDarkMode?<Sun size={20}/>:<Moon size={20}/>}</button>
                                <button onClick={()=>setShowSettingsModal(true)} className={`p-2 rounded-full ${isDarkMode?'bg-white/10':'bg-slate-200'}`}><Settings size={20}/></button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div className={`p-4 rounded-2xl ${THEME.glassCard}`}>
                                <div className={`text-xs uppercase font-bold ${THEME.textMuted}`}>Cash</div>
                                <div className="text-lg font-bold text-blue-400">{formatMoney(cashVal)}</div>
                            </div>
                            <div className={`p-4 rounded-2xl ${THEME.glassCard}`}>
                                <div className={`text-xs uppercase font-bold ${THEME.textMuted}`}>Invested</div>
                                <div className="text-lg font-bold text-purple-400">{formatMoney(stockVal)}</div>
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="relative z-10 px-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        
                        {/* TAB: ACCOUNTS */}
                        {activeTab === 'accounts' && <div className="space-y-3">
                            <h2 className="font-bold text-lg mb-2">Accounts</h2>
                            {accounts.map(a => (
                                <div key={a.id} onClick={()=>{setForm({...a, accType:a.type, interest:a.interestRate}); setModalMode('account'); setIsModalOpen(true)}} className={`p-4 rounded-2xl flex justify-between items-center ${THEME.glassCard} active:scale-95 transition-transform`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-xl ${isDarkMode?'bg-white/5':'bg-slate-100'}`}>üè¶</div>
                                        <div>
                                            <div className="font-bold text-sm">{a.name}</div>
                                            {a.interestRate > 0 && <div className="text-[10px] text-emerald-400">+{a.interestRate}% APY</div>}
                                        </div>
                                    </div>
                                    <div className="font-bold">{formatMoney(a.balance)}</div>
                                </div>
                            ))}
                            {accounts.length === 0 && <div className={`text-center py-10 text-sm ${THEME.textMuted}`}>No accounts. Tap + to add.</div>}
                        </div>}

                        {/* TAB: LEDGER */}
                        {activeTab === 'ledger' && <div className="space-y-4">
                            <div className={`flex justify-between items-center p-3 rounded-xl ${isDarkMode?'bg-white/5':'bg-white border border-slate-200'}`}>
                                <button onClick={()=>setCurrentLedgerDate(new Date(currentLedgerDate.setMonth(currentLedgerDate.getMonth()-1)))}><ChevronLeft/></button>
                                <span className="font-bold text-sm">{currentLedgerDate.toLocaleString('default', {month:'long', year:'numeric'})}</span>
                                <button onClick={()=>setCurrentLedgerDate(new Date(currentLedgerDate.setMonth(currentLedgerDate.getMonth()+1)))}><ChevronRight/></button>
                            </div>

                            <div className="flex gap-2">
                                <div className={`flex-1 p-3 rounded-xl text-center border ${isDarkMode?'border-white/5 bg-white/5':'border-slate-200 bg-white'}`}>
                                    <div className={`text-[10px] uppercase font-bold ${THEME.textMuted}`}>In</div>
                                    <div className="text-emerald-500 font-bold">{formatMoney(totalIncome)}</div>
                                </div>
                                <div className={`flex-1 p-3 rounded-xl text-center border ${isDarkMode?'border-white/5 bg-white/5':'border-slate-200 bg-white'}`}>
                                    <div className={`text-[10px] uppercase font-bold ${THEME.textMuted}`}>Out</div>
                                    <div className="text-rose-500 font-bold">{formatMoney(totalExpense)}</div>
                                </div>
                            </div>

                            <div className="space-y-2">
                                {filteredTransactions.length === 0 && <div className={`text-center py-10 text-sm ${THEME.textMuted}`}>No transactions this month.</div>}
                                {filteredTransactions.map(t => (
                                    <div key={t.id} onClick={()=>{setForm({...t, accId:t.accountId, date: t.date.split('/').reverse().join('-')}); setModalMode('ledger'); setIsModalOpen(true)}} className={`p-3 rounded-2xl flex justify-between items-center ${THEME.glassCard} active:scale-95 transition-transform`}>
                                        <div className="flex gap-3 items-center">
                                            <div className="text-xl">{t.cat.icon}</div>
                                            <div>
                                                <div className="font-bold text-sm">{t.cat.name}</div>
                                                <div className={`text-[10px] ${THEME.textMuted}`}>{t.date} ‚Ä¢ {t.note}</div>
                                            </div>
                                        </div>
                                        <div className={`font-bold ${t.type==='income'?'text-emerald-500':''}`}>{t.type==='expense'?'-':'+'}{t.amount.toFixed(2)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>}

                        {/* TAB: STOCKS */}
                        {activeTab === 'stocks' && <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <h2 className="font-bold text-lg">Portfolio</h2>
                                <button onClick={updatePrices} className="text-xs flex items-center gap-1 opacity-70 border px-2 py-1 rounded-lg"><RefreshCw size={12} className={isUpdatingPrices?'animate-spin-slow':''}/> Update</button>
                            </div>
                            {stocks.map(s => {
                                const gain = (s.currentPrice - s.avgCost) * s.shares;
                                return (
                                    <div key={s.id} onClick={()=>{setForm({...s, cost:s.avgCost, price:s.currentPrice}); setModalMode('stocks'); setIsModalOpen(true)}} className={`p-4 rounded-2xl flex justify-between items-center ${THEME.glassCard} active:scale-95 transition-transform`}>
                                        <div>
                                            <div className="font-bold">{s.symbol}</div>
                                            <div className={`text-xs ${THEME.textMuted}`}>{s.shares} units @ {s.currentPrice}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold">{formatMoney(s.currentPrice * s.shares)}</div>
                                            <div className={`text-xs font-bold ${gain>=0?'text-emerald-500':'text-rose-500'}`}>{gain>=0?'+':''}{formatMoney(gain)}</div>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>}

                        {/* TAB: ANALYTICS */}
                        {activeTab === 'analytics' && <div className="space-y-6">
                            <div className={`p-6 rounded-3xl ${THEME.glassCard}`}>
                                <div className="flex justify-center gap-2 mb-6">
                                    <button onClick={()=>setChartType('expense')} className={`px-4 py-1 rounded-lg text-xs font-bold ${chartType==='expense'?'bg-white text-black':'text-gray-500'}`}>Exp</button>
                                    <button onClick={()=>setChartType('income')} className={`px-4 py-1 rounded-lg text-xs font-bold ${chartType==='income'?'bg-white text-black':'text-gray-500'}`}>Inc</button>
                                </div>
                                <div className="space-y-2">
                                    {analyticsData.slice(0,6).map(([k,v], i) => (
                                        <div key={k} className="flex items-center gap-2 text-sm">
                                            <div className={`w-full bg-gray-700/30 rounded-full h-2 overflow-hidden flex-1`}>
                                                <div className="h-full bg-emerald-500" style={{width: `${(v/(chartType==='expense'?totalExpense:totalIncome))*100}%`}}></div>
                                            </div>
                                            <div className="w-20 text-right font-mono text-xs">{formatMoney(v)}</div>
                                        </div>
                                    ))}
                                    {analyticsData.length===0 && <div className="text-center opacity-50 text-xs">No data</div>}
                                </div>
                            </div>
                            <div className={`p-6 rounded-3xl ${THEME.glassCard} relative overflow-hidden`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold flex items-center gap-2"><Sparkles size={16} className="text-amber-400"/> AI Insight</h3>
                                    <button onClick={getInsight} disabled={isAiLoading} className="text-xs border px-3 py-1 rounded-lg opacity-70">{isAiLoading?'...':'Analyze'}</button>
                                </div>
                                <div className="text-sm opacity-80 leading-relaxed">
                                    {aiAnalysis ? <div dangerouslySetInnerHTML={{__html: aiAnalysis.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}}/> : "Tap Analyze for advice."}
                                </div>
                            </div>
                        </div>}

                    </div>

                    {/* NAV BAR */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-50">
                        <div className={`h-16 rounded-[2rem] flex items-center justify-between px-6 shadow-2xl ${THEME.glassNav}`}>
                            <button onClick={()=>setActiveTab('accounts')} className={activeTab==='accounts'?THEME.navIconActive:THEME.navIconInactive}><Landmark size={24}/></button>
                            <button onClick={()=>setActiveTab('ledger')} className={activeTab==='ledger'?THEME.navIconActive:THEME.navIconInactive}><Wallet size={24}/></button>
                            <button onClick={()=>{setForm({type:'expense'}); setModalMode(activeTab==='stocks'?'stocks':(activeTab==='accounts'?'account':'ledger')); setIsModalOpen(true)}} className={`-mt-10 w-14 h-14 bg-gradient-to-tr ${THEME.accentGradient} rounded-full flex items-center justify-center text-white shadow-lg border-4 ${isDarkMode?'border-[#0B0C15]':'border-white'}`}><Plus size={28}/></button>
                            <button onClick={()=>setActiveTab('analytics')} className={activeTab==='analytics'?THEME.navIconActive:THEME.navIconInactive}><PieChart size={24}/></button>
                            <button onClick={()=>setActiveTab('stocks')} className={activeTab==='stocks'?THEME.navIconActive:THEME.navIconInactive}><Briefcase size={24}/></button>
                        </div>
                    </div>

                    {/* MAIN MODAL */}
                    {isModalOpen && <div className="fixed inset-0 z-[60] flex items-end justify-center sm:items-center">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setIsModalOpen(false)}></div>
                        <div className={`w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl relative animate-in slide-in-from-bottom duration-300 ${isDarkMode?'bg-[#1A1D2D]':'bg-white'}`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg capitalize">{form.id?'Edit':'New'} {modalMode}</h3>
                                <button onClick={()=>setIsModalOpen(false)}><X/></button>
                            </div>

                            {modalMode === 'ledger' && <>
                                <div className="flex gap-2 mb-4 p-1 bg-black/10 rounded-xl">
                                    {['expense','income'].map(t=><button key={t} onClick={()=>setForm({...form, type:t})} className={`flex-1 py-2 rounded-lg font-bold capitalize ${form.type===t?(t==='income'?'bg-emerald-500 text-white':'bg-rose-500 text-white'):'opacity-50'}`}>{t}</button>)}
                                </div>
                                <input type="number" placeholder="0.00" autoFocus className={`w-full text-4xl font-bold bg-transparent outline-none mb-4 ${THEME.textMain}`} value={form.amount||''} onChange={e=>setForm({...form, amount:e.target.value})}/>
                                <div className="flex gap-3 overflow-x-auto pb-4 mb-2 no-scrollbar">
                                    {CATEGORIES[form.type||'expense'].map(c=><button key={c.name} onClick={()=>setForm({...form, cat:c})} className={`min-w-[70px] flex flex-col items-center gap-1 p-2 rounded-xl border ${form.cat?.name===c.name?'border-emerald-500 bg-emerald-500/10':'border-transparent'}`}><div className="text-2xl">{c.icon}</div><div className="text-[10px]">{c.name}</div></button>)}
                                </div>
                                <select className={`w-full p-4 rounded-xl mb-4 ${THEME.inputBg}`} value={form.accId||''} onChange={e=>setForm({...form, accId:e.target.value})}>
                                    <option value="">Account (Optional)</option>
                                    {accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                                </select>
                                <input className={`w-full p-4 rounded-xl mb-4 ${THEME.inputBg}`} placeholder="Note" value={form.note||''} onChange={e=>setForm({...form, note:e.target.value})}/>
                                <div className="flex gap-2">
                                    {form.id && <button onClick={()=>setDeleteTarget({id:form.id, type:'tx'})} className="p-4 rounded-xl bg-rose-500/10 text-rose-500"><Trash2/></button>}
                                    <button onClick={saveTx} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save</button>
                                </div>
                            </>}

                            {modalMode === 'account' && <>
                                <input className={`w-full p-4 rounded-xl mb-3 ${THEME.inputBg}`} placeholder="Name" value={form.name||''} onChange={e=>setForm({...form, name:e.target.value})}/>
                                <div className="flex gap-3 mb-4">
                                    <input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Balance" value={form.balance||''} onChange={e=>setForm({...form, balance:e.target.value})}/>
                                    <input type="number" className={`w-1/3 p-4 rounded-xl ${THEME.inputBg}`} placeholder="APY %" value={form.interest||''} onChange={e=>setForm({...form, interest:e.target.value})}/>
                                </div>
                                <div className="flex gap-2">
                                    {form.id && <button onClick={()=>setDeleteTarget({id:form.id, type:'acc'})} className="p-4 rounded-xl bg-rose-500/10 text-rose-500"><Trash2/></button>}
                                    <button onClick={saveAcc} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save</button>
                                </div>
                            </>}

                            {modalMode === 'stocks' && <>
                                <input className={`w-full p-4 rounded-xl mb-3 uppercase ${THEME.inputBg}`} placeholder="Symbol" value={form.symbol||''} onChange={e=>setForm({...form, symbol:e.target.value})}/>
                                <div className="flex gap-3 mb-4">
                                    <input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Units" value={form.shares||''} onChange={e=>setForm({...form, shares:e.target.value})}/>
                                    <input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Avg Cost" value={form.cost||''} onChange={e=>setForm({...form, cost:e.target.value})}/>
                                </div>
                                <div className="flex gap-2">
                                    {form.id && <button onClick={()=>setDeleteTarget({id:form.id, type:'stock'})} className="p-4 rounded-xl bg-rose-500/10 text-rose-500"><Trash2/></button>}
                                    <button onClick={saveStock} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save</button>
                                </div>
                            </>}
                        </div>
                    </div>}

                    {/* SETTINGS MODAL */}
                    {showSettingsModal && <div className="fixed inset-0 z-[70] flex items-center justify-center p-6">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setShowSettingsModal(false)}></div>
                        <div className={`w-full max-w-sm rounded-3xl p-6 relative border shadow-2xl ${isDarkMode?'bg-[#1A1D2D] border-white/10':'bg-white'}`}>
                            <h3 className="font-bold mb-4">Settings</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className={`text-xs uppercase font-bold mb-2 block ${THEME.textMuted}`}>Gemini API Key</label>
                                    <div className={`flex gap-2 p-2 rounded-xl border ${keyStatus==='valid'?'border-emerald-500':'border-white/10'}`}>
                                        <input type="password" className={`bg-transparent w-full outline-none text-sm px-2 ${THEME.textMain}`} placeholder="Paste Key" value={apiKey} onChange={e=>setApiKey(e.target.value)}/>
                                        <button onClick={verifyKey} className="text-xs bg-white/10 px-2 rounded">Verify</button>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleBackup} className={`flex-1 py-3 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 ${isDarkMode?'border-white/10':'border-slate-200'}`}><Download size={14}/> Backup</button>
                                    <button onClick={()=>fileInputRef.current.click()} className={`flex-1 py-3 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 ${isDarkMode?'border-white/10':'border-slate-200'}`}><Upload size={14}/> Restore</button>
                                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleRestore}/>
                                </div>
                                <button onClick={()=>{if(confirm('Reset?')) {localStorage.clear(); location.reload()}}} className="w-full py-3 rounded-xl bg-rose-500/10 text-rose-500 font-bold text-xs">Reset All Data</button>
                            </div>
                        </div>
                    </div>}

                    {/* DELETE CONFIRM */}
                    {deleteTarget && <div className="fixed inset-0 z-[80] flex items-center justify-center p-6">
                         <div className="absolute inset-0 bg-black/80" onClick={()=>setDeleteTarget(null)}></div>
                         <div className="relative bg-white text-black p-6 rounded-2xl w-full max-w-xs text-center">
                             <h3 className="font-bold mb-4">Delete item?</h3>
                             <div className="flex gap-2"><button onClick={()=>setDeleteTarget(null)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button><button onClick={confirmDelete} className="flex-1 py-2 bg-rose-500 text-white rounded-lg">Delete</button></div>
                         </div>
                    </div>}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


