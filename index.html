<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aurora Assets</title>
    
    <meta name="theme-color" content="#0B0C15">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            -webkit-user-select: none; 
            font-family: 'Outfit', sans-serif;
        }
        input, select { user-select: text; -webkit-user-select: text; }
        
        /* Markdown-like styling for AI response */
        .ai-response ul { list-style-type: disc; margin-left: 1.2em; margin-bottom: 0.5em; }
        .ai-response li { margin-bottom: 0.2em; }
        .ai-response strong { font-weight: 700; color: #34d399; }
        .ai-response p { margin-bottom: 0.5em; }

        /* Animation Utilities */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
    </style>
</head>
<body class="bg-[#0B0C15] text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- GET GLOBALS (This fixes the black screen) ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        const { 
            Plus, Trash2, Wallet, TrendingUp, TrendingDown, X, 
            PieChart, Briefcase, Landmark, CreditCard, 
            Download, Upload, RefreshCw, Sun, Moon, Settings, Key, ShieldCheck, ShieldAlert, Sparkles, ChevronLeft, ChevronRight
        } = lucide;

        const App = () => {
            // --- 1. CONFIGURATION & STATE ---
            const [isDarkMode, setIsDarkMode] = useState(true);
            const fileInputRef = useRef(null); 
            
            const THEME = isDarkMode ? {
                bg: "bg-[#0B0C15]", 
                glassCard: "bg-white/[0.06] backdrop-blur-xl border border-white/[0.08] shadow-2xl",
                glassNav: "bg-[#161822]/90 backdrop-blur-2xl border-t border-white/[0.08]",
                textMain: "text-white/90",
                textMuted: "text-white/40",
                inputBg: "bg-black/40",
                accentGradient: "from-emerald-400 to-teal-500",
                navIconActive: "text-emerald-300",
                navIconInactive: "text-gray-500",
                cardHover: "active:bg-white/10"
            } : {
                bg: "bg-slate-100", 
                glassCard: "bg-white shadow-lg border border-slate-200",
                glassNav: "bg-white/90 backdrop-blur-2xl border-t border-slate-200",
                textMain: "text-slate-800",
                textMuted: "text-slate-500",
                inputBg: "bg-slate-50",
                accentGradient: "from-emerald-500 to-teal-600",
                navIconActive: "text-emerald-600",
                navIconInactive: "text-slate-400",
                cardHover: "active:bg-slate-50"
            };

            const [activeTab, setActiveTab] = useState('accounts'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('ledger'); 
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null); 
            
            // Data
            const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-ledger-pro')) || []; } catch { return []; } });
            const [stocks, setStocks] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-stocks-pro')) || []; } catch { return []; } });
            const [accounts, setAccounts] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-accounts-pro')) || []; } catch { return []; } });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('aurora-api-key') || ''); 
            
            const [currentLedgerDate, setCurrentLedgerDate] = useState(new Date());
            const [chartType, setChartType] = useState('expense'); 
            
            // AI State
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [keyStatus, setKeyStatus] = useState('none');
            const [isUpdatingPrices, setIsUpdatingPrices] = useState(false);

            // Persistence
            useEffect(() => { localStorage.setItem('aurora-ledger-pro', JSON.stringify(transactions)); }, [transactions]);
            useEffect(() => { localStorage.setItem('aurora-stocks-pro', JSON.stringify(stocks)); }, [stocks]);
            useEffect(() => { localStorage.setItem('aurora-accounts-pro', JSON.stringify(accounts)); }, [accounts]);
            useEffect(() => { localStorage.setItem('aurora-api-key', apiKey); }, [apiKey]);
            useEffect(() => { lucide.createIcons(); }, [activeTab, isModalOpen, showSettingsModal, transactions, accounts, stocks]);

            const formatMoney = (n) => new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR', minimumFractionDigits: 2 }).format(n || 0);
            
            const CATEGORIES = {
                expense: [
                    { name: 'Food', icon: 'ðŸœ', color: 'text-orange-400' },
                    { name: 'Grocery', icon: 'ðŸ¥¦', color: 'text-green-400' },
                    { name: 'Transport', icon: 'ðŸš—', color: 'text-yellow-400' },
                    { name: 'Medical', icon: 'ðŸ’Š', color: 'text-red-400' },
                    { name: 'Shopping', icon: 'ðŸ›ï¸', color: 'text-purple-400' },
                    { name: 'Rent', icon: 'ðŸ ', color: 'text-blue-400' },
                    { name: 'Utilities', icon: 'âš¡', color: 'text-sky-400' },
                    { name: 'Travel', icon: 'âœˆï¸', color: 'text-teal-400' }
                ],
                income: [
                    { name: 'Salary', icon: 'ðŸ’¼', color: 'text-indigo-400' },
                    { name: 'Refund', icon: 'â†©ï¸', color: 'text-gray-400' },
                    { name: 'Interest', icon: 'ðŸ“ˆ', color: 'text-emerald-400' },
                    { name: 'Dividend', icon: 'ðŸ’°', color: 'text-amber-400' },
                    { name: 'Bonus', icon: 'ðŸ†', color: 'text-rose-400' }
                ]
            };

            // --- FORMS STATE ---
            const [editingTx, setEditingTx] = useState(null);
            const [editingAcc, setEditingAcc] = useState(null);
            const [editingStock, setEditingStock] = useState(null);
            const [amount, setAmount] = useState('');
            const [ledgerType, setLedgerType] = useState('expense');
            const [selectedCat, setSelectedCat] = useState(CATEGORIES.expense[0]);
            const [selectedAccountId, setSelectedAccountId] = useState('');
            const [note, setNote] = useState('');
            const [txDate, setTxDate] = useState('');
            const [stockName, setStockName] = useState('');
            const [stockSymbol, setStockSymbol] = useState('');
            const [stockShares, setStockShares] = useState('');
            const [stockCost, setStockCost] = useState('');
            const [stockPrice, setStockPrice] = useState('');
            const [accName, setAccName] = useState('');
            const [accBalance, setAccBalance] = useState('');
            const [accInterest, setAccInterest] = useState('');
            const [accType, setAccType] = useState('bank');

            // --- DERIVED DATA ---
            const filteredTransactions = transactions.filter(t => {
                const parts = t.date.split('/');
                if (parts.length !== 3) return false;
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                return month - 1 === currentLedgerDate.getMonth() && year === currentLedgerDate.getFullYear();
            }).sort((a,b) => b.timestamp - a.timestamp);
            
            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((a,c) => a + c.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((a,c) => a + c.amount, 0);
            const stockMarketVal = stocks.reduce((a,c) => a + (c.currentPrice * c.shares), 0);
            const totalCashSavings = accounts.reduce((a,c) => a + c.balance, 0);
            const totalNetWorth = totalCashSavings + stockMarketVal;

            const analyticsData = useMemo(() => {
                const map = {};
                filteredTransactions.filter(t => t.type === chartType).forEach(t => {
                    const catName = t.cat?.name || 'Unknown';
                    map[catName] = (map[catName] || 0) + t.amount;
                });
                return Object.entries(map).sort((a,b) => b[1] - a[1]);
            }, [filteredTransactions, chartType]);

            // --- MANUAL FETCH FOR AI (NO SDK) ---
            const generateContent = async (prompt) => {
                if (!apiKey) throw new Error("No API Key");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            };

            const verifyApiKey = async () => {
                if (!apiKey) return alert("Please enter API Key");
                setKeyStatus('verifying');
                try {
                    await generateContent("Hello");
                    setKeyStatus('valid');
                } catch (e) {
                    setKeyStatus('invalid');
                }
            };

            const callAI = async () => {
                if (!apiKey) return setShowSettingsModal(true);
                setIsAiLoading(true);
                const summary = `Net Worth: RM${totalNetWorth}, Cash: RM${totalCashSavings}, Stocks: RM${stockMarketVal}, Income: RM${totalIncome}, Expense: RM${totalExpense}`;
                try {
                    const text = await generateContent(`Act as a financial advisor. Analyze this summary: ${summary}. Give 3 short actionable bullet points (max 60 words).`);
                    setAiAnalysis(text);
                } catch (error) {
                    setAiAnalysis("Error connecting to AI. Check API Key.");
                }
                setIsAiLoading(false);
            };

            const refreshStockPrices = async () => {
                if (stocks.length === 0) return alert("No stocks to update.");
                setIsUpdatingPrices(true);
                const updatedStocks = [...stocks];
                let successCount = 0;

                for (let i = 0; i < updatedStocks.length; i++) {
                    const stock = updatedStocks[i];
                    if (!stock.symbol) continue;
                    try {
                        const proxyUrl = "https://api.allorigins.win/raw?url=";
                        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${stock.symbol}?interval=1d&range=1d`;
                        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                        if (!response.ok) throw new Error("Network error");
                        const data = await response.json();
                        const price = data.chart.result[0].meta.regularMarketPrice;
                        if (price) {
                            updatedStocks[i] = { ...stock, currentPrice: price };
                            successCount++;
                        }
                    } catch (error) { console.error(error); }
                }
                setStocks(updatedStocks);
                setIsUpdatingPrices(false);
                alert(`Updated ${successCount} stocks.`);
            };

            // --- EXPORT/BACKUP ---
            const handleExportCsv = () => {
                const rows = transactions.map(t => [t.date, t.type, t.cat?.name, t.amount, `"${t.note}"`]);
                const csv = ['Date,Type,Category,Amount,Note', ...rows.map(r => r.join(','))].join('\n');
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download='aurora.csv'; link.click();
            };

            const handleBackup = () => {
                const data = { transactions, accounts, stocks, apiKey };
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'})); link.download='aurora_backup.json'; link.click();
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = JSON.parse(e.target.result);
                    if(confirm("Restore data?")) {
                        if(data.transactions) setTransactions(data.transactions);
                        if(data.accounts) setAccounts(data.accounts);
                        if(data.stocks) setStocks(data.stocks);
                        if(data.apiKey) setApiKey(data.apiKey);
                        alert("Restored!");
                    }
                };
                reader.readAsText(file);
            };

            // --- UI ACTIONS ---
            const handleSaveTx = () => {
                if(!amount) return;
                const d = txDate ? new Date(txDate) : new Date();
                const formatted = d.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const val = parseFloat(amount);
                
                // Account Update logic
                if (!editingTx && selectedAccountId) {
                    const targetAcc = accounts.find(a => a.id == selectedAccountId);
                    if (targetAcc) {
                        const newBal = ledgerType === 'income' ? targetAcc.balance + val : targetAcc.balance - val;
                        setAccounts(accounts.map(a => a.id === targetAcc.id ? { ...a, balance: newBal } : a));
                    }
                }

                const newTx = { id: editingTx ? editingTx.id : Date.now(), type: ledgerType, amount: val, cat: selectedCat, note: note||'Others', date: formatted, timestamp: d.getTime(), accountId: selectedAccountId };
                
                if(editingTx) setTransactions(transactions.map(t => t.id===editingTx.id ? newTx : t));
                else setTransactions([newTx, ...transactions]);
                
                setIsModalOpen(false);
            };

            const handleSaveAccount = () => {
                if(!accName) return;
                const newAcc = { id: editingAcc ? editingAcc.id : Date.now(), name: accName, type: accType, balance: parseFloat(accBalance)||0, interestRate: parseFloat(accInterest)||0, icon: 'ðŸ¦' };
                if(editingAcc) setAccounts(accounts.map(a => a.id===editingAcc.id ? newAcc : a));
                else setAccounts([...accounts, newAcc]);
                setIsModalOpen(false);
            };

            const handleSaveStock = () => {
                if(!stockSymbol) return;
                const newStock = { id: editingStock ? editingStock.id : Date.now(), name: stockName||stockSymbol, symbol: stockSymbol, shares: parseFloat(stockShares)||0, avgCost: parseFloat(stockCost)||0, currentPrice: parseFloat(stockPrice)||parseFloat(stockCost)||0 };
                if(editingStock) setStocks(stocks.map(s => s.id===editingStock.id ? newStock : s));
                else setStocks([...stocks, newStock]);
                setIsModalOpen(false);
            };

            const deleteItem = () => {
                if(!deleteTarget) return;
                if(deleteTarget.type==='tx') setTransactions(transactions.filter(t => t.id!==deleteTarget.id));
                if(deleteTarget.type==='acc') setAccounts(accounts.filter(a => a.id!==deleteTarget.id));
                if(deleteTarget.type==='stock') setStocks(stocks.filter(s => s.id!==deleteTarget.id));
                setDeleteTarget(null); setIsModalOpen(false);
            };

            return (
                <div className={`min-h-screen ${THEME.bg} ${THEME.textMain} relative overflow-x-hidden pb-28 font-sans`}>
                    {/* Header */}
                    <div className="pt-8 px-6 pb-4">
                         <div className="flex justify-between items-start mb-6">
                            <div><span className={`text-xs font-bold uppercase ${THEME.textMuted}`}>Net Worth</span><h1 className="text-4xl font-bold">{formatMoney(totalNetWorth)}</h1></div>
                            <div className="flex gap-3">
                                <button onClick={()=>setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${isDarkMode?'bg-white/10':'bg-slate-200'}`}>{isDarkMode?<Sun size={18}/>:<Moon size={18}/>}</button>
                                <button onClick={()=>setShowSettingsModal(true)} className={`p-2 rounded-full ${isDarkMode?'bg-white/10':'bg-slate-200'}`}><Settings size={18}/></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className={`${THEME.glassCard} p-3 rounded-2xl`}><span className={`text-[10px] uppercase block ${THEME.textMuted}`}>Cash</span><span className="text-lg font-bold text-blue-400">{formatMoney(totalCashSavings)}</span></div>
                            <div className={`${THEME.glassCard} p-3 rounded-2xl`}><span className={`text-[10px] uppercase block ${THEME.textMuted}`}>Stocks</span><span className="text-lg font-bold text-purple-400">{formatMoney(stockMarketVal)}</span></div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="px-6">
                        <div className="flex justify-between items-end mb-4">
                            <h2 className="text-lg font-bold capitalize">{activeTab}</h2>
                            {activeTab === 'stocks' && <button onClick={refreshStockPrices} disabled={isUpdatingPrices} className="text-xs px-3 py-1.5 border rounded-lg flex gap-1 items-center"><RefreshCw size={12} className={isUpdatingPrices?'animate-spin':''}/> Update</button>}
                        </div>

                        {activeTab === 'accounts' && <div className="space-y-3">
                            {accounts.map(a => (
                                <div key={a.id} onClick={()=>{setEditingAcc(a); setAccName(a.name); setAccBalance(a.balance); setAccInterest(a.interestRate); setModalMode('account'); setIsModalOpen(true)}} className={`${THEME.glassCard} p-4 rounded-2xl flex justify-between items-center`}>
                                    <div><div className="font-bold text-sm">{a.name}</div>{a.interestRate>0 && <div className="text-[10px] text-emerald-400">+{a.interestRate}% Interest</div>}</div>
                                    <div className="text-xl font-bold">{formatMoney(a.balance)}</div>
                                </div>
                            ))}
                            {accounts.length===0 && <div className={`text-center py-10 text-sm ${THEME.textMuted}`}>No accounts. Tap +</div>}
                        </div>}

                        {activeTab === 'ledger' && <div className="space-y-4">
                             <div className="flex gap-2 mb-2">
                                <div className={`flex-1 p-2 rounded-xl text-center border ${isDarkMode?'border-white/10':'border-slate-200'}`}><div className={`text-[10px] uppercase ${THEME.textMuted}`}>Income</div><div className="text-emerald-500 font-bold">{formatMoney(totalIncome)}</div></div>
                                <div className={`flex-1 p-2 rounded-xl text-center border ${isDarkMode?'border-white/10':'border-slate-200'}`}><div className={`text-[10px] uppercase ${THEME.textMuted}`}>Expense</div><div className="text-rose-500 font-bold">{formatMoney(totalExpense)}</div></div>
                            </div>
                            {transactions.map(t => (
                                <div key={t.id} onClick={()=>{setEditingTx(t); setAmount(t.amount); setLedgerType(t.type); setNote(t.note); setIsModalOpen(true); setModalMode('ledger')}} className={`${THEME.glassCard} p-3 rounded-2xl flex justify-between items-center`}>
                                    <div className="flex gap-3 items-center">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-xl ${isDarkMode?'bg-white/5':'bg-slate-100'}`}>{t.cat?.icon}</div>
                                        <div><div className="text-sm font-bold">{t.cat?.name}</div><div className={`text-[10px] ${THEME.textMuted}`}>{t.date} â€¢ {t.note}</div></div>
                                    </div>
                                    <div className={`font-bold ${t.type==='income'?'text-emerald-500':''}`}>{t.type==='expense'?'-':'+'}{t.amount.toFixed(2)}</div>
                                </div>
                            ))}
                        </div>}

                        {activeTab === 'stocks' && <div className="space-y-3">
                            {stocks.map(s => (
                                <div key={s.id} onClick={()=>{setEditingStock(s); setStockName(s.name); setStockSymbol(s.symbol); setStockShares(s.shares); setStockCost(s.avgCost); setStockPrice(s.currentPrice); setModalMode('stocks'); setIsModalOpen(true)}} className={`${THEME.glassCard} p-4 rounded-2xl flex justify-between items-center`}>
                                    <div><div className="font-bold text-sm">{s.name}</div><div className={`text-[10px] ${THEME.textMuted}`}>{s.shares} units</div></div>
                                    <div className="text-right"><div className="font-bold">{formatMoney(s.currentPrice*s.shares)}</div><div className={`text-[10px] ${(s.currentPrice>=s.avgCost)?'text-emerald-500':'text-rose-500'}`}>{((s.currentPrice-s.avgCost)/s.avgCost*100).toFixed(1)}%</div></div>
                                </div>
                            ))}
                        </div>}

                         {activeTab === 'analytics' && <div>
                            <div className={`${THEME.glassCard} p-6 rounded-3xl mb-4 text-center`}>
                                <div className="text-sm mb-2 uppercase tracking-wide text-gray-500">Top Expenses</div>
                                {analyticsData.slice(0,5).map(([k,v]) => <div key={k} className="flex justify-between text-xs py-1 border-b border-white/5"><span>{k}</span><span>{formatMoney(v)}</span></div>)}
                            </div>
                            <div className={`${THEME.glassCard} p-5 rounded-2xl`}>
                                <div className="flex justify-between mb-2 items-center"><h3 className="font-bold text-sm flex gap-2"><Sparkles size={14} className="text-amber-400"/> AI Insight</h3><button onClick={callAI} disabled={isAiLoading} className="text-[10px] border px-2 py-1 rounded">{isAiLoading?'...':'Analyze'}</button></div>
                                <div className="text-xs opacity-70 leading-relaxed" dangerouslySetInnerHTML={{__html: aiAnalysis.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') || 'Tap Analyze for insights.'}}></div>
                            </div>
                        </div>}
                    </div>

                    {/* Navigation */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-50">
                        <div className={`${THEME.glassNav} h-16 rounded-[2rem] flex items-center justify-between px-6 shadow-2xl`}>
                            <button onClick={()=>setActiveTab('accounts')} className={activeTab==='accounts'?THEME.navIconActive:THEME.navIconInactive}><Landmark size={22}/></button>
                            <button onClick={()=>setActiveTab('ledger')} className={activeTab==='ledger'?THEME.navIconActive:THEME.navIconInactive}><Wallet size={22}/></button>
                            <button onClick={()=>{setIsModalOpen(true); setModalMode(activeTab==='stocks'?'stocks':(activeTab==='accounts'?'account':'ledger')); setEditingTx(null); setEditingAcc(null); setEditingStock(null); setAmount(''); setTxDate('');}} className={`-mt-8 w-14 h-14 bg-gradient-to-tr ${THEME.accentGradient} rounded-full flex items-center justify-center text-white shadow-xl border-4 ${isDarkMode?'border-[#0B0C15]':'border-slate-50'}`}><Plus size={28}/></button>
                            <button onClick={()=>setActiveTab('analytics')} className={activeTab==='analytics'?THEME.navIconActive:THEME.navIconInactive}><PieChart size={22}/></button>
                            <button onClick={()=>setActiveTab('stocks')} className={activeTab==='stocks'?THEME.navIconActive:THEME.navIconInactive}><Briefcase size={22}/></button>
                        </div>
                    </div>

                    {/* MODAL */}
                    {isModalOpen && <div className="fixed inset-0 z-[60] flex items-end justify-center">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setIsModalOpen(false)}></div>
                        <div className={`w-full max-w-md rounded-t-[2rem] p-6 relative border-t animate-in slide-in-from-bottom duration-300 ${isDarkMode ? 'bg-[#1A1D2D] border-white/10' : 'bg-white border-slate-200'}`}>
                            {modalMode === 'ledger' && <>
                                <div className="flex gap-2 mb-4">{['expense','income'].map(t=><button key={t} onClick={()=>setLedgerType(t)} className={`flex-1 py-2 rounded-lg capitalize font-bold ${ledgerType===t?'bg-white/10 text-white':'text-gray-500'}`}>{t}</button>)}</div>
                                <div className="flex gap-4 mb-4"><input type="number" placeholder="0.00" className={`text-4xl bg-transparent w-full font-bold outline-none ${THEME.textMain}`} value={amount} onChange={e=>setAmount(e.target.value)} /><input type="date" className="bg-transparent text-sm" value={txDate} onChange={e=>setTxDate(e.target.value)}/></div>
                                <select className={`w-full p-3 rounded-xl mb-4 text-sm ${THEME.inputBg}`} value={selectedAccountId} onChange={e=>setSelectedAccountId(e.target.value)}><option value="">Select Account</option>{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select>
                                <div className="flex gap-4 overflow-x-auto pb-4 mb-2">{CATEGORIES[ledgerType].map(c=><button key={c.name} onClick={()=>setSelectedCat(c)} className={`min-w-[60px] flex flex-col items-center gap-1 opacity-${selectedCat.name===c.name?'100':'50'}`}><div className="text-2xl">{c.icon}</div><span className="text-[10px]">{c.name}</span></button>)}</div>
                                <input className={`w-full p-3 rounded-xl mb-4 text-sm ${THEME.inputBg}`} placeholder="Note" value={note} onChange={e=>setNote(e.target.value)}/>
                                <div className="flex gap-2">{editingTx && <button onClick={()=>setDeleteTarget({id:editingTx.id, type:'tx'})} className="p-4 bg-rose-500/10 text-rose-500 rounded-xl"><Trash2 size={20}/></button>}<button onClick={handleSaveTx} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save</button></div>
                            </>}

                            {modalMode === 'account' && <>
                                <input className={`w-full p-4 rounded-xl mb-3 ${THEME.inputBg}`} placeholder="Account Name" value={accName} onChange={e=>setAccName(e.target.value)}/>
                                <div className="flex gap-3 mb-3"><input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Balance" value={accBalance} onChange={e=>setAccBalance(e.target.value)}/><input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Interest %" value={accInterest} onChange={e=>setAccInterest(e.target.value)}/></div>
                                <div className="flex gap-2">{editingAcc && <button onClick={()=>setDeleteTarget({id:editingAcc.id, type:'acc'})} className="p-4 bg-rose-500/10 text-rose-500 rounded-xl"><Trash2 size={20}/></button>}<button onClick={handleSaveAccount} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save Account</button></div>
                            </>}

                            {modalMode === 'stocks' && <>
                                <input className={`w-full p-4 rounded-xl mb-3 ${THEME.inputBg}`} placeholder="Symbol (e.g. 1155.KL)" value={stockSymbol} onChange={e=>setStockSymbol(e.target.value)}/>
                                <input className={`w-full p-4 rounded-xl mb-3 ${THEME.inputBg}`} placeholder="Name (e.g. Maybank)" value={stockName} onChange={e=>setStockName(e.target.value)}/>
                                <div className="flex gap-3 mb-3"><input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Units" value={stockShares} onChange={e=>setStockShares(e.target.value)}/><input type="number" className={`flex-1 p-4 rounded-xl ${THEME.inputBg}`} placeholder="Avg Cost" value={stockCost} onChange={e=>setStockCost(e.target.value)}/></div>
                                <div className="flex gap-2">{editingStock && <button onClick={()=>setDeleteTarget({id:editingStock.id, type:'stock'})} className="p-4 bg-rose-500/10 text-rose-500 rounded-xl"><Trash2 size={20}/></button>}<button onClick={handleSaveStock} className={`flex-1 py-4 rounded-xl font-bold text-white bg-gradient-to-r ${THEME.accentGradient}`}>Save Stock</button></div>
                            </>}
                        </div>
                    </div>}

                    {/* SETTINGS MODAL */}
                    {showSettingsModal && <div className="fixed inset-0 z-[70] flex items-center justify-center p-6">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setShowSettingsModal(false)}></div>
                        <div className={`w-full max-w-sm rounded-3xl p-6 relative border shadow-2xl ${isDarkMode?'bg-[#1A1D2D] border-white/10':'bg-white'}`}>
                            <h3 className="font-bold mb-4 text-lg">Settings</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className={`text-xs uppercase font-bold mb-2 block ${THEME.textMuted}`}>Gemini API Key</label>
                                    <div className={`flex items-center gap-2 p-3 rounded-xl border ${keyStatus==='valid'?'border-emerald-500/50':'border-white/10'} ${THEME.inputBg}`}>
                                        <Key size={16} className="opacity-50"/>
                                        <input type="password" className="bg-transparent w-full outline-none text-sm" placeholder="Paste Key" value={apiKey} onChange={e=>setApiKey(e.target.value)}/>
                                        <button onClick={verifyApiKey} className="text-xs font-bold px-2 py-1 bg-white/10 rounded">Verify</button>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleBackup} className={`flex-1 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${isDarkMode?'bg-white/5':'bg-slate-100'}`}><Download size={14}/> Backup</button>
                                    <button onClick={()=>fileInputRef.current.click()} className={`flex-1 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${isDarkMode?'bg-white/5':'bg-slate-100'}`}><Upload size={14}/> Restore</button>
                                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleRestore}/>
                                </div>
                                <button onClick={()=>{if(confirm('Reset all?')) {localStorage.clear(); location.reload()}}} className="w-full py-3 rounded-xl bg-rose-500/10 text-rose-500 font-bold text-xs">Reset All Data</button>
                            </div>
                        </div>
                    </div>}

                    {/* CONFIRM DELETE MODAL */}
                    {deleteTarget && <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                         <div className="absolute inset-0 bg-black/80" onClick={()=>setDeleteTarget(null)}></div>
                         <div className="relative bg-white text-black p-6 rounded-2xl w-64 text-center">
                             <h3 className="font-bold mb-4">Are you sure?</h3>
                             <div className="flex gap-2"><button onClick={()=>setDeleteTarget(null)} className="flex-1 py-2 bg-gray-200 rounded-lg">Cancel</button><button onClick={deleteItem} className="flex-1 py-2 bg-rose-500 text-white rounded-lg">Delete</button></div>
                         </div>
                    </div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
