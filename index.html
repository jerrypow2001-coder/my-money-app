<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aurora Assets</title>
    
    <meta name="theme-color" content="#0B0C15">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aurora">
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            -webkit-user-select: none; 
            font-family: 'Outfit', sans-serif;
        }
        input, select { user-select: text; -webkit-user-select: text; }
        
        /* Markdown-like styling for AI response */
        .ai-response ul { list-style-type: disc; margin-left: 1.2em; margin-bottom: 0.5em; }
        .ai-response li { margin-bottom: 0.2em; }
        .ai-response strong { font-weight: 700; color: #34d399; }
        .ai-response p { margin-bottom: 0.5em; }

        /* Animation Utilities */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        .animate-spin-slow { animation: spin 2s linear infinite; }
    </style>
</head>
<body class="bg-[#0B0C15] text-white overflow-hidden">
    <div id="root"></div>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "@google/generative-ai": "https://esm.sh/@google/generative-ai"
        }
    }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // IMPORT GOOGLE SDK
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { 
            Plus, Trash2, Wallet, TrendingUp, TrendingDown, X, 
            PieChart, Briefcase, Landmark, CreditCard, 
            MoreHorizontal, Download, Upload, Calculator, Coins, RefreshCw,
            Sun, Moon, Target, CalendarClock, CheckCircle, AlertCircle, Save,
            ChevronLeft, ChevronRight, Calendar, AlertTriangle, Wifi, WifiOff, Link as LinkIcon, ArrowRightLeft,
            Sparkles, Settings, Key, ShieldCheck, ShieldAlert
        } from 'lucide-react';

        const App = () => {
            // --- 1. CONFIGURATION & STATE ---
            const [isDarkMode, setIsDarkMode] = useState(true);
            const fileInputRef = useRef(null); 
            
            const THEME = isDarkMode ? {
                mode: 'dark',
                bg: "bg-[#0B0C15]", 
                glassCard: "bg-white/[0.06] backdrop-blur-xl border border-white/[0.08] shadow-2xl",
                glassNav: "bg-[#161822]/90 backdrop-blur-2xl border-t border-white/[0.08]",
                textMain: "text-white/90",
                textMuted: "text-white/40",
                textHighlight: "text-emerald-400",
                inputBg: "bg-black/40",
                accentGradient: "from-emerald-400 to-teal-500",
                navIconActive: "text-emerald-300",
                navIconInactive: "text-gray-500",
                cardHover: "active:bg-white/10",
                deleteBtn: "text-rose-500/50 hover:text-rose-500 hover:bg-rose-500/10"
            } : {
                mode: 'light',
                bg: "bg-slate-100", 
                glassCard: "bg-white shadow-lg border border-slate-200",
                glassNav: "bg-white/90 backdrop-blur-2xl border-t border-slate-200",
                textMain: "text-slate-800",
                textMuted: "text-slate-500",
                textHighlight: "text-emerald-600",
                inputBg: "bg-slate-50",
                accentGradient: "from-emerald-500 to-teal-600",
                navIconActive: "text-emerald-600",
                navIconInactive: "text-slate-400",
                cardHover: "active:bg-slate-50",
                deleteBtn: "text-slate-300 hover:text-rose-500 hover:bg-rose-50"
            };

            const [activeTab, setActiveTab] = useState('accounts'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('ledger'); 
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null); 
            
            // Data
            const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-ledger-pro')) || []; } catch { return []; } });
            const [stocks, setStocks] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-stocks-pro')) || []; } catch { return []; } });
            const [accounts, setAccounts] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-accounts-pro')) || []; } catch { return []; } });
            const [budgets, setBudgets] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-budgets-pro')) || []; } catch { return []; } });
            const [recurringRules, setRecurringRules] = useState(() => { try { return JSON.parse(localStorage.getItem('aurora-recurring-pro')) || []; } catch { return []; } });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('aurora-api-key') || ''); 
            
            const [currentLedgerDate, setCurrentLedgerDate] = useState(new Date());
            const [chartType, setChartType] = useState('expense'); 
            
            // AI State
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [keyStatus, setKeyStatus] = useState('none'); // 'none', 'verifying', 'valid', 'invalid'
            const [isUpdatingPrices, setIsUpdatingPrices] = useState(false);

            // Persistence
            useEffect(() => { localStorage.setItem('aurora-ledger-pro', JSON.stringify(transactions)); }, [transactions]);
            useEffect(() => { localStorage.setItem('aurora-stocks-pro', JSON.stringify(stocks)); }, [stocks]);
            useEffect(() => { localStorage.setItem('aurora-accounts-pro', JSON.stringify(accounts)); }, [accounts]);
            useEffect(() => { localStorage.setItem('aurora-budgets-pro', JSON.stringify(budgets)); }, [budgets]);
            useEffect(() => { localStorage.setItem('aurora-recurring-pro', JSON.stringify(recurringRules)); }, [recurringRules]);
            useEffect(() => { localStorage.setItem('aurora-api-key', apiKey); }, [apiKey]);

            // --- 2. HELPERS ---
            const formatMoney = (n) => new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR', minimumFractionDigits: 2 }).format(n || 0);
            const getCatColor = (base, light) => isDarkMode ? base : light;
            
            const CATEGORIES = useMemo(() => ({
                expense: [
                    { name: 'Food', icon: 'ðŸœ', color: getCatColor('bg-orange-400/20 text-orange-300', 'bg-orange-100 text-orange-600') },
                    { name: 'Grocery', icon: 'ðŸ¥¦', color: getCatColor('bg-green-400/20 text-green-300', 'bg-green-100 text-green-600') },
                    { name: 'Transport', icon: 'ðŸš—', color: getCatColor('bg-yellow-400/20 text-yellow-300', 'bg-yellow-100 text-yellow-600') },
                    { name: 'Lending', icon: 'ðŸ¤', color: getCatColor('bg-pink-400/20 text-pink-300', 'bg-pink-100 text-pink-600') }, 
                    { name: 'Medical', icon: 'ðŸ’Š', color: getCatColor('bg-red-400/20 text-red-300', 'bg-red-100 text-red-600') }, 
                    { name: 'Shopping', icon: 'ðŸ›ï¸', color: getCatColor('bg-purple-400/20 text-purple-300', 'bg-purple-100 text-purple-600') },
                    { name: 'Rent', icon: 'ðŸ ', color: getCatColor('bg-blue-400/20 text-blue-300', 'bg-blue-100 text-blue-600') },
                    { name: 'Utilities', icon: 'âš¡', color: getCatColor('bg-sky-400/20 text-sky-300', 'bg-sky-100 text-sky-600') },
                    { name: 'Travel', icon: 'âœˆï¸', color: getCatColor('bg-teal-400/20 text-teal-300', 'bg-teal-100 text-teal-600') }
                ],
                income: [
                    { name: 'Salary', icon: 'ðŸ’¼', color: getCatColor('bg-indigo-400/20 text-indigo-300', 'bg-indigo-100 text-indigo-600') },
                    { name: 'Refund', icon: 'â†©ï¸', color: getCatColor('bg-gray-400/20 text-gray-300', 'bg-gray-100 text-gray-600') }, 
                    { name: 'Interest', icon: 'ðŸ“ˆ', color: getCatColor('bg-emerald-400/20 text-emerald-300', 'bg-emerald-100 text-emerald-600') },
                    { name: 'Dividend', icon: 'ðŸ’°', color: getCatColor('bg-amber-400/20 text-amber-300', 'bg-amber-100 text-amber-600') },
                    { name: 'Bonus', icon: 'ðŸ†', color: getCatColor('bg-rose-400/20 text-rose-300', 'bg-rose-100 text-rose-600') }
                ]
            }), [isDarkMode]);

            // --- 3. AUTOMATION ---
            // Interest Automation
            useEffect(() => {
                if (accounts.length === 0) return;
                const todayStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                let interestAdded = false;
                let newTx = [...transactions];
                let newAcc = [...accounts];

                newAcc = newAcc.map(acc => {
                    if (acc.interestRate > 0) {
                        const lastRun = acc.lastInterestDate || todayStr;
                        if (lastRun !== todayStr) {
                            const [d1, m1, y1] = lastRun.split('/').map(Number);
                            const [d2, m2, y2] = todayStr.split('/').map(Number);
                            
                            if (isNaN(d1) || isNaN(d2)) return acc;

                            const diffTime = Math.abs(new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1));
                            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            
                            if (days > 0) {
                                let interest = (acc.balance * (acc.interestRate / 100) / 365) * days;
                                interest = parseFloat(interest.toFixed(2));

                                if (interest > 0) {
                                    acc.balance += interest;
                                    interestAdded = true;
                                    newTx.unshift({ 
                                        id: Date.now() + Math.random(), 
                                        type: 'income', 
                                        amount: interest, 
                                        cat: CATEGORIES.income.find(c => c.name === 'Interest') || CATEGORIES.income[0], 
                                        note: `Auto Interest (${acc.name})`, 
                                        date: todayStr, 
                                        timestamp: Date.now(),
                                        accountId: acc.id
                                    });
                                }
                                acc.lastInterestDate = todayStr;
                                interestAdded = true; 
                            }
                        }
                    }
                    return acc;
                });

                if (interestAdded) {
                    setAccounts(newAcc);
                    setTransactions(newTx);
                }
            }, [accounts.length]);

            const getTabAmbience = () => {
                if (activeTab === 'accounts') return isDarkMode ? { blob1: 'bg-blue-600/20', blob2: 'bg-cyan-500/20' } : { blob1: 'bg-blue-400/30', blob2: 'bg-cyan-400/30' };
                if (activeTab === 'ledger') return isDarkMode ? { blob1: 'bg-emerald-500/15', blob2: 'bg-teal-600/15' } : { blob1: 'bg-emerald-400/30', blob2: 'bg-teal-400/30' };
                if (activeTab === 'stocks') return isDarkMode ? { blob1: 'bg-purple-600/20', blob2: 'bg-indigo-500/20' } : { blob1: 'bg-purple-400/30', blob2: 'bg-indigo-400/30' };
                if (activeTab === 'analytics') return isDarkMode ? { blob1: 'bg-pink-600/20', blob2: 'bg-rose-500/20' } : { blob1: 'bg-pink-400/30', blob2: 'bg-rose-400/30' };
                return { blob1: 'bg-gray-500/10', blob2: 'bg-gray-500/10' };
            };
            const tabAmbience = getTabAmbience();

            // --- 4. FORMS STATE ---
            const [editingTx, setEditingTx] = useState(null);
            const [editingAcc, setEditingAcc] = useState(null);
            const [editingStock, setEditingStock] = useState(null);
            const [amount, setAmount] = useState('');
            const [ledgerType, setLedgerType] = useState('expense');
            const [selectedCat, setSelectedCat] = useState(CATEGORIES.expense[0]);
            const [selectedAccountId, setSelectedAccountId] = useState('');
            const [note, setNote] = useState('');
            const [txDate, setTxDate] = useState('');
            const [stockName, setStockName] = useState('');
            const [stockSymbol, setStockSymbol] = useState('');
            const [stockShares, setStockShares] = useState('');
            const [stockCost, setStockCost] = useState('');
            const [stockPrice, setStockPrice] = useState('');
            const [accName, setAccName] = useState('');
            const [accBalance, setAccBalance] = useState('');
            const [accInterest, setAccInterest] = useState('');
            const [accType, setAccType] = useState('bank');

            // --- 5. DERIVED DATA ---
            const filteredTransactions = useMemo(() => transactions.filter(t => {
                const parts = t.date.split('/');
                if (parts.length !== 3) return false;
                // Parse safely
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                return month - 1 === currentLedgerDate.getMonth() && year === currentLedgerDate.getFullYear();
            }).sort((a,b) => b.timestamp - a.timestamp), [transactions, currentLedgerDate]);
            
            const groupedTransactions = useMemo(() => {
                const g = [];
                filteredTransactions.forEach(t => {
                    const last = g[g.length-1];
                    if(last && last.date === t.date) {
                        last.items.push(t);
                    } else {
                        const parts = t.date.split('/');
                        // Robust Date Parsing
                        let dateObj = new Date();
                        if (parts.length === 3) {
                             dateObj = new Date(parseInt(parts[2]), parseInt(parts[1])-1, parseInt(parts[0]));
                        }
                        g.push({ 
                            date: t.date, 
                            displayDate: dateObj.toLocaleDateString('en-US', {day:'numeric', month:'short'}), 
                            dayName: dateObj.toLocaleDateString('en-US', {weekday:'short'}), 
                            items: [t] 
                        });
                    }
                });
                return g;
            }, [filteredTransactions]);

            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((a,c) => a + c.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((a,c) => a + c.amount, 0);
            const stockMarketVal = stocks.reduce((a,c) => a + (c.currentPrice * c.shares), 0);
            const totalCashSavings = accounts.reduce((a,c) => a + c.balance, 0);
            const totalNetWorth = totalCashSavings + stockMarketVal;
            
            const analyticsData = useMemo(() => {
                const map = {};
                filteredTransactions.filter(t => t.type === chartType).forEach(t => {
                    const catName = t.cat?.name || 'Unknown';
                    map[catName] = (map[catName] || 0) + t.amount;
                });
                return Object.entries(map).sort((a,b) => b[1] - a[1]);
            }, [filteredTransactions, chartType]);

            // --- 6. HANDLERS & AI (UPDATED WITH SDK) ---
            
            const verifyApiKey = async () => {
                if (!apiKey) {
                    alert("Please enter an API Key first.");
                    return;
                }
                setKeyStatus('verifying');
                try {
                    // Use SDK
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    
                    const result = await model.generateContent("Hello");
                    const response = await result.response;
                    
                    if (response) {
                        setKeyStatus('valid');
                    } else {
                        setKeyStatus('invalid');
                    }
                } catch (e) {
                    console.error("Key Verification Error:", e);
                    setKeyStatus('invalid');
                }
            };

            const refreshStockPrices = async () => {
                if (!apiKey) {
                    setShowSettingsModal(true);
                    alert("Please set a valid API Key to use AI features.");
                    return;
                }
                if (stocks.length === 0) return alert("No stocks to update.");
                
                setIsUpdatingPrices(true);
                const symbols = stocks.map(s => s.symbol).filter(s => s);
                
                if(symbols.length === 0) {
                    setIsUpdatingPrices(false);
                    return alert("No valid symbols found.");
                }

                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });

                    const prompt = `You are a financial data assistant. I need the approximate last known market price for these stock symbols: ${symbols.join(', ')}. 
                    IMPORTANT:
                    1. Return ONLY a valid JSON object. No markdown formatting, no code blocks.
                    2. The keys must be the exact symbols provided.
                    3. The values must be the price as a number (no currency symbols).
                    4. If you absolutely cannot find a price, use null.
                    
                    Example Output: {"AAPL": 150.50, "1155.KL": 8.90}`;

                    const result = await model.generateContent(prompt);
                    const text = result.response.text();
                    
                    if (text) {
                        // Cleanup markdown if AI adds it
                        const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const priceMap = JSON.parse(cleanText);
                        
                        const newStocks = stocks.map(s => {
                            if (priceMap[s.symbol] && typeof priceMap[s.symbol] === 'number') {
                                return { ...s, currentPrice: priceMap[s.symbol] };
                            }
                            return s;
                        });
                        
                        setStocks(newStocks);
                        alert("Prices updated based on AI estimates.");
                    } else {
                        alert("AI failed to return data.");
                    }
                } catch (error) {
                    console.error("Stock Update Error:", error);
                    alert("Failed to update prices. Check network or API Key.");
                }
                setIsUpdatingPrices(false);
            };

            const callAI = async () => {
                if (!apiKey) {
                    setShowSettingsModal(true);
                    return;
                }
                setIsAiLoading(true);
                
                // Prepare prompt data
                const summary = `
                    Net Worth: RM${totalNetWorth}
                    Cash: RM${totalCashSavings}
                    Stocks: RM${stockMarketVal}
                    This Month Income: RM${totalIncome}
                    This Month Expense: RM${totalExpense}
                    Top Expenses: ${analyticsData.slice(0, 3).map(i => `${i[0]}: RM${i[1]}`).join(', ')}
                `;

                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    
                    const prompt = `Act as a financial advisor. Analyze this monthly financial summary and give 3 short, concise, actionable bullet points for advice. Format in Markdown (use **bold**). Keep it under 60 words. \n\n${summary}`;

                    const result = await model.generateContent(prompt);
                    const text = result.response.text();

                    if (text) {
                        setAiAnalysis(text);
                    } else {
                        setAiAnalysis("Could not generate insight. Check API Key quota.");
                    }
                } catch (error) {
                    console.error("AI Insight Error:", error);
                    setAiAnalysis("Error connecting to AI. Please check API Key.");
                }
                setIsAiLoading(false);
            };

            const handleExportCsv = () => {
                if (transactions.length === 0) return alert("No records.");
                const headers = ['Date', 'Type', 'Category', 'Account', 'Amount', 'Note'];
                const rows = transactions.map(t => {
                    const accName = accounts.find(a => a.id === t.accountId)?.name || '-';
                    return [t.date, t.type, t.cat?.name, accName, t.amount, `"${t.note}"`];
                });
                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download='aurora_ledger.csv'; link.click();
            };

            // --- 7. NEW: IMPORT/EXPORT FULL BACKUP ---
            const handleBackup = () => {
                const data = {
                    transactions, accounts, stocks, budgets, recurringRules, apiKey
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aurora_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.transactions && !data.accounts && !data.stocks) throw new Error("Invalid file");
                        
                        if(confirm("This will replace your current data with the backup file. Continue?")) {
                            if(data.transactions) localStorage.setItem('aurora-ledger-pro', JSON.stringify(data.transactions));
                            if(data.stocks) localStorage.setItem('aurora-stocks-pro', JSON.stringify(data.stocks));
                            if(data.accounts) localStorage.setItem('aurora-accounts-pro', JSON.stringify(data.accounts));
                            if(data.budgets) localStorage.setItem('aurora-budgets-pro', JSON.stringify(data.budgets));
                            if(data.recurringRules) localStorage.setItem('aurora-recurring-pro', JSON.stringify(data.recurringRules));
                            if(data.apiKey) localStorage.setItem('aurora-api-key', data.apiKey);
                            
                            alert("Restore successful! Reloading app...");
                            window.location.reload();
                        }
                    } catch (err) {
                        alert("Error restoring data. Invalid file format.");
                    }
                };
                reader.readAsText(file);
                // Reset input
                event.target.value = null;
            };

            const handleMonthChange = (direction) => {
                const newDate = new Date(currentLedgerDate);
                newDate.setMonth(currentLedgerDate.getMonth() + direction);
                setCurrentLedgerDate(newDate);
            };

            const openEditTx = (tx) => { 
                setEditingTx(tx); setAmount(tx.amount); setLedgerType(tx.type); setSelectedCat(tx.cat); setNote(tx.note); setSelectedAccountId(tx.accountId || '');
                // Convert DD/MM/YYYY to YYYY-MM-DD for input
                const parts = tx.date.split('/'); 
                if(parts.length===3) setTxDate(`${parts[2]}-${parts[1]}-${parts[0]}`);
                setModalMode('ledger'); setIsModalOpen(true); 
            };
            
            const openNewTx = () => { 
                setEditingTx(null); setAmount(''); setNote(''); setSelectedAccountId(accounts[0]?.id || ''); 
                setTxDate(new Date().toISOString().split('T')[0]); setModalMode('ledger'); setIsModalOpen(true); 
            };

            const handleSaveTx = () => {
                if(!amount) return;
                const d = txDate ? new Date(txDate) : new Date();
                // Ensure correct day string regardless of timezone
                const formatted = d.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const val = parseFloat(amount);

                if (!editingTx && selectedAccountId) {
                    const targetAcc = accounts.find(a => a.id == selectedAccountId); 
                    if (targetAcc) {
                        const newBalance = ledgerType === 'income' ? targetAcc.balance + val : targetAcc.balance - val;
                        setAccounts(accounts.map(a => a.id === targetAcc.id ? { ...a, balance: parseFloat(newBalance.toFixed(2)) } : a));
                    }
                }

                if(editingTx) {
                    setTransactions(transactions.map(t => t.id===editingTx.id ? {
                        ...t, type: ledgerType, amount: val, cat: selectedCat, note: note||'Others', date: formatted, timestamp: d.getTime(), accountId: selectedAccountId
                    } : t));
                } else {
                    setTransactions([{
                        id: Date.now(), type: ledgerType, amount: val, cat: selectedCat, note: note||'Others', date: formatted, timestamp: d.getTime(), accountId: selectedAccountId
                    }, ...transactions]);
                }
                setIsModalOpen(false);
            };

            const openAddAccount = () => { setEditingAcc(null); setAccName(''); setAccBalance(''); setAccInterest(''); setAccType('bank'); setModalMode('account'); setIsModalOpen(true); };
            const openEditAccount = (acc) => { setEditingAcc(acc); setAccName(acc.name); setAccBalance(acc.balance); setAccInterest(acc.interestRate); setAccType(acc.type); setModalMode('account'); setIsModalOpen(true); };
            const handleSaveAccount = () => {
                if(!accName) return;
                const bal = parseFloat(accBalance)||0; const rate = parseFloat(accInterest)||0;
                let icon = 'ðŸ¦';
                if (accType === 'ewallet') icon = 'ðŸ“±';
                else if (accType === 'cash') icon = 'ðŸ’µ';
                else if (accType === 'investment') icon = 'ðŸ“ˆ';
                else if (accType === 'pocket') icon = 'ðŸ’°';
                
                if(editingAcc) setAccounts(accounts.map(a => a.id===editingAcc.id ? {...a, name: accName, type: accType, balance: bal, interestRate: rate, icon} : a));
                else setAccounts([...accounts, {id: Date.now(), name: accName, type: accType, balance: bal, interestRate: rate, icon, lastInterestDate: new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'numeric'})}]);
                setIsModalOpen(false);
            };

            const openEditStock = (s) => { setEditingStock(s); setStockName(s.name); setStockSymbol(s.symbol); setStockShares(s.shares); setStockCost(s.avgCost); setStockPrice(s.currentPrice); setModalMode('stocks'); setIsModalOpen(true); };
            const openAddStock = () => { setEditingStock(null); setStockName(''); setStockSymbol(''); setStockShares(''); setStockCost(''); setStockPrice(''); setModalMode('stocks'); setIsModalOpen(true); };
            const handleSaveStock = () => {
                if(!stockSymbol) return;
                const name = stockName || stockSymbol; const shares = parseFloat(stockShares)||0; const cost = parseFloat(stockCost)||0; const price = parseFloat(stockPrice)||cost;
                if(editingStock) setStocks(stocks.map(s => s.id===editingStock.id ? {...s, name, symbol: stockSymbol, shares, avgCost: cost, currentPrice: price} : s));
                else setStocks([...stocks, {id: Date.now(), name, symbol: stockSymbol, shares, avgCost: cost, currentPrice: price}]);
                setIsModalOpen(false);
            };
            
            const handleFabClick = () => {
                if (activeTab === 'accounts') openAddAccount();
                else if (activeTab === 'stocks') openAddStock();
                else openNewTx();
            };

            const requestDelete = (id, type) => { setDeleteTarget({ id, type }); };
            const confirmDelete = () => {
                if(!deleteTarget) return;
                if(deleteTarget.type==='tx') setTransactions(transactions.filter(t => t.id !== deleteTarget.id));
                else if(deleteTarget.type==='recurring') setRecurringRules(recurringRules.filter(r => r.id !== deleteTarget.id));
                else if(deleteTarget.type==='account') setAccounts(accounts.filter(a => a.id !== deleteTarget.id));
                else if(deleteTarget.type==='stock') setStocks(stocks.filter(s => s.id !== deleteTarget.id));
                setDeleteTarget(null); setIsModalOpen(false);
            };

            const DailyInterestLabel = ({ principal, rate }) => {
                if (!rate) return null;
                const daily = (principal * (rate / 100)) / 365;
                return <div className={`text-[10px] font-medium flex items-center gap-1 mt-2 w-fit px-2 py-0.5 rounded ${isDarkMode ? 'bg-emerald-400/10 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}><TrendingUp size={10} /> +RM{daily.toFixed(2)} / day</div>;
            };

            return (
                <div className={`min-h-screen ${THEME.bg} ${THEME.textMain} relative overflow-hidden selection:bg-teal-500/30 pb-28 transition-colors duration-300`}>
                    <div className={`fixed top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full blur-[120px] pointer-events-none mix-blend-screen animate-blob ${tabAmbience.blob1}`} />
                    <div className={`fixed bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full blur-[120px] pointer-events-none mix-blend-screen animate-blob animation-delay-2000 ${tabAmbience.blob2}`} />
                    
                    {/* HEADER */}
                    <div className="relative pt-8 pb-6 px-6 z-10">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <span className={`text-xs font-bold tracking-widest uppercase ${THEME.textMuted} mb-1`}>Total Net Worth</span>
                                <h1 className={`text-4xl font-bold tracking-tight ${isDarkMode ? 'text-white drop-shadow-lg' : 'text-slate-900'}`}>{formatMoney(totalNetWorth)}</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full transition-all ${isDarkMode ? 'bg-white/10 text-yellow-300' : 'bg-slate-200 text-slate-600'}`}>{isDarkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                                <button onClick={() => setShowSettingsModal(true)} className={`p-2 rounded-full transition-all ${isDarkMode ? 'bg-white/10 text-white' : 'bg-slate-200 text-slate-800'}`}><Settings size={18}/></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className={`${THEME.glassCard} p-3 rounded-2xl`}>
                                <span className={`text-[10px] uppercase block ${THEME.textMuted}`}>Cash</span>
                                <span className="text-lg font-bold text-blue-400">{formatMoney(totalCashSavings)}</span>
                            </div>
                            <div className={`${THEME.glassCard} p-3 rounded-2xl`}>
                                <span className={`text-[10px] uppercase block ${THEME.textMuted}`}>Stocks</span>
                                <span className="text-lg font-bold text-purple-400">{formatMoney(stockMarketVal)}</span>
                            </div>
                        </div>
                    </div>

                    {/* CONTENT */}
                    <div className="px-6 relative z-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="flex justify-between items-end mb-4 mt-2">
                            <h2 className={`text-lg font-bold ${isDarkMode ? 'text-white/80' : 'text-slate-700'}`}>
                                {activeTab === 'accounts' ? 'My Accounts' : activeTab === 'ledger' ? 'Transactions' : activeTab === 'analytics' ? 'Analytics' : 'Investments'}
                            </h2>
                            <div className="flex gap-2">
                                {activeTab === 'stocks' && <button onClick={refreshStockPrices} disabled={isUpdatingPrices} className={`flex items-center gap-1.5 text-xs font-bold px-3 py-1.5 rounded-lg border transition-all ${isDarkMode ? 'text-indigo-400 bg-indigo-400/10 border-indigo-400/20' : 'text-indigo-700 bg-indigo-100 border-indigo-200'}`}>
                                    <RefreshCw size={14} className={isUpdatingPrices ? 'animate-spin-slow' : ''} /> <span>{isUpdatingPrices ? 'Updating...' : 'Auto-Update'}</span>
                                </button>}
                                <button onClick={handleExportCsv} className={`flex items-center gap-1.5 text-xs font-bold px-3 py-1.5 rounded-lg border transition-all ${isDarkMode ? 'text-emerald-400 bg-emerald-400/10 border-emerald-400/20' : 'text-emerald-700 bg-emerald-100 border-emerald-200'}`}><Download size={14} /> <span>CSV</span></button>
                            </div>
                        </div>

                        {/* ACCOUNTS TAB */}
                        {activeTab === 'accounts' && <div className="space-y-3">
                            {accounts.length === 0 && <div className={`text-center py-10 text-sm ${THEME.textMuted}`}>No accounts added. Tap + to add one.</div>}
                            {accounts.map(acc => (
                                <div key={acc.id} onClick={() => openEditAccount(acc)} className={`${THEME.glassCard} rounded-2xl relative p-4 ${THEME.cardHover} transition-transform cursor-pointer`}>
                                    <div className="flex justify-between items-center mb-1">
                                        <div className="flex items-center gap-3">
                                            <div className={`text-2xl w-12 h-12 flex items-center justify-center rounded-2xl ${isDarkMode?'bg-white/5':'bg-slate-100'}`}>{acc.icon}</div>
                                            <div className="flex flex-col">
                                                <span className={`text-xs font-bold ${THEME.textMuted} uppercase tracking-wide`}>{acc.name}</span>
                                                {acc.interestRate > 0 && <span className="flex items-center gap-1 text-[10px] text-emerald-400 mt-0.5"><TrendingUp size={10}/> {acc.interestRate}%</span>}
                                            </div>
                                        </div>
                                        <div className={`text-xl font-bold ${THEME.textMain}`}>{formatMoney(acc.balance)}</div>
                                    </div>
                                    {acc.interestRate > 0 && <DailyInterestLabel principal={acc.balance} rate={acc.interestRate} />}
                                </div>
                            ))}
                        </div>}

                        {/* LEDGER TAB */}
                        {activeTab === 'ledger' && <div className="space-y-4">
                            <div className={`flex justify-between p-3 rounded-2xl ${isDarkMode?'bg-white/5':'bg-slate-200/50'}`}>
                                <button onClick={() => handleMonthChange(-1)}><ChevronLeft size={20} className={THEME.textMain}/></button>
                                <span className={`text-sm font-bold ${THEME.textMain}`}>{currentLedgerDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                                <button onClick={() => handleMonthChange(1)}><ChevronRight size={20} className={THEME.textMain}/></button>
                            </div>
                            <div className="flex gap-2 mb-4">
                                <div className={`flex-1 p-3 rounded-xl border text-center ${isDarkMode?'bg-white/5 border-white/5':'bg-white/50 border-slate-200'}`}><span className={`text-[10px] uppercase font-bold ${THEME.textMuted}`}>In</span><div className="text-emerald-500 font-bold">{formatMoney(totalIncome)}</div></div>
                                <div className={`flex-1 p-3 rounded-xl border text-center ${isDarkMode?'bg-white/5 border-white/5':'bg-white/50 border-slate-200'}`}><span className={`text-[10px] uppercase font-bold ${THEME.textMuted}`}>Out</span><div className="text-rose-500 font-bold">{formatMoney(totalExpense)}</div></div>
                            </div>
                            {groupedTransactions.length === 0 ? <div className={`text-center py-10 ${THEME.textMuted}`}>No records</div> : groupedTransactions.map(g => (
                                <div key={g.date} className="mb-2">
                                    <div className={`text-[10px] font-bold uppercase tracking-widest mb-2 pl-1 ${THEME.textMuted}`}>{g.displayDate} Â· {g.dayName}</div>
                                    <div className="space-y-2">{g.items.map(t => (
                                        <div key={t.id} onClick={() => openEditTx(t)} className={`${THEME.glassCard} rounded-2xl p-3 flex justify-between items-center ${THEME.cardHover} cursor-pointer`}>
                                            <div className="flex gap-3 items-center">
                                                <div className={`text-xl w-10 h-10 flex items-center justify-center rounded-xl ${isDarkMode?'bg-white/5':'bg-slate-100'}`}>{t.cat?.icon}</div>
                                                <div className="flex flex-col">
                                                    <span className={`text-sm font-bold ${THEME.textMain}`}>{t.cat?.name || 'Unknown'}</span>
                                                    <span className={`text-[10px] ${THEME.textMuted} flex items-center gap-1`}>
                                                        {t.accountId && accounts.find(a=>a.id==t.accountId) && <span className={`px-1 rounded ${isDarkMode?'bg-white/10':'bg-slate-200'}`}>{accounts.find(a=>a.id==t.accountId).name}</span>}
                                                        {t.note || '-'}
                                                    </span>
                                                </div>
                                            </div>
                                            <span className={`text-sm font-bold ${t.type==='income'?'text-emerald-500':THEME.textMain}`}>{t.type==='expense'?'-':'+'}{t.amount.toFixed(2)}</span>
                                        </div>
                                    ))}</div>
                                </div>
                            ))}
                        </div>}

                        {/* STOCKS TAB */}
                        {activeTab === 'stocks' && <div className="space-y-3">
                            {stocks.length === 0 && <div className={`text-center py-10 text-sm ${THEME.textMuted}`}>No holdings added. Tap + to start.</div>}
                            {stocks.map(s => {
                                const mv = s.currentPrice * s.shares; const isGain = s.currentPrice >= s.avgCost;
                                return (
                                    <div key={s.id} onClick={() => {setEditingStock(s); setStockName(s.name); setStockSymbol(s.symbol); setStockShares(s.shares); setStockCost(s.avgCost); setStockPrice(s.currentPrice); setModalMode('stocks'); setIsModalOpen(true);}} className={`${THEME.glassCard} rounded-2xl p-4 flex justify-between items-center cursor-pointer ${THEME.cardHover} transition-all`}>
                                            <div className="flex items-center gap-4 flex-1">
                                                <div className={`w-10 h-10 flex items-center justify-center rounded-xl font-bold text-xs border mb-2 ${isDarkMode?'bg-amber-400/20 border-amber-400/20 text-amber-300':'bg-amber-100 border-amber-200 text-amber-700'}`}>{s.name.substring(0,3).toUpperCase()}</div>
                                                <div className="flex flex-col">
                                                    <span className={`text-sm font-bold ${THEME.textMain}`}>{s.name}</span>
                                                    <span className={`text-[10px] ${THEME.textMuted}`}>{s.shares} units @ {s.avgCost}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`font-bold text-sm ${THEME.textMain}`}>{formatMoney(mv)}</div>
                                                <div className={`text-[10px] font-bold ${isGain?'text-emerald-500':'text-rose-500'}`}>{isGain?'+':''}{formatMoney(mv - s.avgCost*s.shares)}</div>
                                            </div>
                                    </div>
                                )
                            })}
                        </div>}

                        {/* ANALYTICS TAB */}
                        {activeTab === 'analytics' && <div className="space-y-6">
                            <div className="flex justify-center">
                                <div className={`flex p-1 rounded-xl ${isDarkMode ? 'bg-white/10' : 'bg-slate-200'}`}>
                                    <button onClick={() => setChartType('expense')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${chartType === 'expense' ? (isDarkMode ? 'bg-white text-black' : 'bg-white text-slate-800 shadow') : 'text-gray-500'}`}>Expenses</button>
                                    <button onClick={() => setChartType('income')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${chartType === 'income' ? (isDarkMode ? 'bg-white text-black' : 'bg-white text-slate-800 shadow') : 'text-gray-500'}`}>Income</button>
                                </div>
                            </div>

                            <div className={`${THEME.glassCard} p-6 rounded-3xl flex flex-col items-center`}>
                                <div className="relative w-48 h-48 rounded-full" style={{ background: `conic-gradient(${analyticsData.length > 0 ? analyticsData.map((i,idx,arr) => { const tot=arr.reduce((a,x)=>a+x[1],0); const prev=arr.slice(0,idx).reduce((a,x)=>a+(x[1]/tot)*100,0); const p=(i[1]/tot)*100; return `${idx%2===0?'#10b981':'#3b82f6'} ${prev}% ${prev+p}%`; }).join(', ') : '#333 0% 100%'})` }}>
                                    <div className={`absolute inset-4 rounded-full flex items-center justify-center ${isDarkMode?'bg-[#0B0C15]':'bg-slate-50'}`}>
                                        <div className="text-center">
                                            <span className={`block text-xs uppercase ${THEME.textMuted}`}>{chartType === 'expense' ? 'Total Exp' : 'Total Inc'}</span>
                                            <span className={`block text-xl font-bold ${THEME.textMain}`}>{formatMoney(chartType === 'expense' ? totalExpense : totalIncome)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="w-full mt-6 grid grid-cols-2 gap-2">
                                    {analyticsData.length > 0 ? analyticsData.map(([k,v]) => (
                                        <div key={k} className="flex justify-between text-xs">
                                            <span className={THEME.textMain}>{k}</span>
                                            <span className={THEME.textMuted}>{formatMoney(v)}</span>
                                        </div>
                                    )) : <div className={`col-span-2 text-center text-xs ${THEME.textMuted}`}>No data available</div>}
                                </div>
                            </div>

                            {/* AI INSIGHT */}
                            <div className={`${THEME.glassCard} p-5 rounded-2xl relative overflow-hidden transition-all duration-300`}>
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className={`text-sm font-bold flex items-center gap-2 ${THEME.textMain}`}><Sparkles size={16} className="text-amber-400" /> AI Insight</h3>
                                    <button onClick={callAI} disabled={isAiLoading} className={`text-xs px-3 py-1 rounded-full border transition-all ${isDarkMode?'border-white/20 hover:bg-white/10':'border-slate-300 hover:bg-slate-200'} ${isAiLoading?'opacity-50 cursor-not-allowed':''}`}>{isAiLoading ? 'Thinking...' : 'Analyze'}</button>
                                </div>
                                <div className={`text-xs leading-relaxed min-h-[60px] ${THEME.textMuted}`}>
                                    {isAiLoading && <div className="animate-pulse space-y-2"><div className="h-2 bg-slate-700 rounded w-3/4"></div><div className="h-2 bg-slate-700 rounded w-1/2"></div></div>}
                                    {!isAiLoading && (aiAnalysis ? <div className="ai-response" dangerouslySetInnerHTML={{__html: aiAnalysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>')}} /> : "Tap Analyze to get AI-powered financial advice based on your current data.")}
                                </div>
                            </div>
                        </div>}
                    </div>

                    {/* BOTTOM NAV */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-50">
                        <div className={`${THEME.glassNav} h-16 rounded-[2rem] flex items-center justify-between px-2 shadow-2xl`}>
                            <button onClick={() => setActiveTab('accounts')} className={`p-3 rounded-full transition-all ${activeTab==='accounts' ? THEME.navIconActive : THEME.navIconInactive}`}><Landmark size={20}/></button>
                            <button onClick={() => setActiveTab('ledger')} className={`p-3 rounded-full transition-all ${activeTab==='ledger' ? THEME.navIconActive : THEME.navIconInactive}`}><Wallet size={20}/></button>
                            <button onClick={handleFabClick} className={`-mt-8 w-14 h-14 bg-gradient-to-tr ${THEME.accentGradient} rounded-full flex items-center justify-center text-white shadow-xl border-4 transform hover:scale-105 transition-transform ${isDarkMode ? 'border-[#0B0C15]' : 'border-slate-50'}`}><Plus size={28} /></button>
                            <button onClick={() => setActiveTab('analytics')} className={`p-3 rounded-full transition-all ${activeTab==='analytics' ? THEME.navIconActive : THEME.navIconInactive}`}><PieChart size={20}/></button>
                            <button onClick={() => setActiveTab('stocks')} className={`p-3 rounded-full transition-all ${activeTab==='stocks' ? THEME.navIconActive : THEME.navIconInactive}`}><Briefcase size={20}/></button>
                        </div>
                    </div>

                    {/* GENERIC MODAL */}
                    {isModalOpen && <div className="fixed inset-0 z-[60] flex items-end justify-center">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300" onClick={()=>setIsModalOpen(false)}></div>
                        <div className={`w-full max-w-md rounded-t-[2.5rem] p-6 relative border-t animate-in slide-in-from-bottom duration-300 ${isDarkMode ? 'bg-[#1A1D2D] border-white/10' : 'bg-white border-slate-200'}`}>
                            <div className={`w-12 h-1 rounded-full mx-auto mb-6 ${isDarkMode?'bg-white/10':'bg-slate-200'}`}></div>
                            {modalMode === 'ledger' && <>
                                <div className={`flex p-1 rounded-2xl mb-6 ${isDarkMode?'bg-black/20':'bg-slate-100'}`}>{['expense', 'income'].map(t => <button key={t} onClick={()=>{setLedgerType(t); setSelectedCat(CATEGORIES[t][0])}} className={`flex-1 py-3 rounded-xl text-sm font-bold capitalize transition-all ${ledgerType===t ? (isDarkMode?'bg-white/10 text-white':'bg-white text-slate-900 shadow') : 'text-gray-500'}`}>{t}</button>)}</div>
                                <div className="flex items-end gap-2 mb-6">
                                    <div className="flex-1"><p className={`text-[10px] font-bold mb-1 ${THEME.textMuted}`}>Amount</p><input type="number" placeholder="0.00" autoFocus className={`bg-transparent text-4xl font-bold w-full outline-none ${isDarkMode?'text-white':'text-slate-900'}`} value={amount} onChange={e=>setAmount(e.target.value)}/></div>
                                    <div><p className={`text-[10px] font-bold mb-1 ${THEME.textMuted}`}>Date</p><input type="date" onClick={(e)=>e.target.showPicker&&e.target.showPicker()} className={`bg-transparent text-sm outline-none w-32 pl-4 cursor-pointer text-right ${THEME.textMain}`} value={txDate} onChange={e=>setTxDate(e.target.value)}/></div>
                                </div>
                                
                                {/* Account Selection */}
                                <div className="mb-4">
                                    <p className={`text-[10px] font-bold mb-2 ${THEME.textMuted}`}>Link Account (Updates Balance)</p>
                                    <select 
                                        className={`w-full p-3 rounded-xl text-sm outline-none appearance-none ${THEME.inputBg} ${THEME.textMain}`}
                                        value={selectedAccountId}
                                        onChange={(e) => setSelectedAccountId(e.target.value)}
                                    >
                                        <option value="">Select Account (Optional)</option>
                                        {accounts.map(acc => <option key={acc.id} value={acc.id}>{acc.icon} {acc.name}</option>)}
                                    </select>
                                </div>

                                <div className="mb-6 flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x">{CATEGORIES[ledgerType].map(c => <button key={c.name} onClick={()=>setSelectedCat(c)} className="flex flex-col items-center gap-2 min-w-[64px] snap-center"><div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl border-2 transition-all ${selectedCat.name===c.name ? `border-emerald-500/50 ${c.color}` : `border-transparent opacity-50 ${isDarkMode?'bg-white/5':'bg-slate-100'}`}`}>{c.icon}</div><span className="text-[10px]">{c.name}</span></button>)}</div>
                                <input className={`w-full p-4 rounded-xl text-sm mb-4 outline-none border border-transparent focus:border-white/20 transition-all ${THEME.inputBg} ${THEME.textMain}`} placeholder="Note (e.g. Others)" value={note} onChange={e=>setNote(e.target.value)} />
                                <div className="flex gap-3">
                                    {editingTx && <button onClick={()=>requestDelete(editingTx.id, 'tx')} className="p-4 rounded-xl bg-rose-500/10 text-rose-500 hover:bg-rose-500/20"><Trash2 size={20}/></button>}
                                    <button onClick={handleSaveTx} className={`flex-1 py-4 rounded-xl bg-gradient-to-r ${THEME.accentGradient} text-white font-bold shadow-lg active:scale-95 transition-transform`}>{editingTx ? 'Update' : 'Save'}</button>
                                </div>
                            </>}
                            {modalMode === 'account' && <>
                                <h3 className={`text-center text-xs tracking-widest uppercase mb-6 ${THEME.textMuted}`}>{editingAcc ? 'Edit Account' : 'New Account'}</h3>
                                <div className="space-y-4 mb-6">
                                    <input className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} placeholder="Name" value={accName} onChange={e=>setAccName(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-4"><select className={`p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} value={accType} onChange={e=>setAccType(e.target.value)}><option value="bank">Bank</option><option value="ewallet">E-Wallet</option><option value="cash">Cash</option><option value="pocket">Pocket</option><option value="investment">Invest</option></select><input type="number" className={`p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} placeholder="Balance" value={accBalance} onChange={e=>setAccBalance(e.target.value)} /></div>
                                    <input type="number" className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} placeholder="Interest Rate % (Annual)" value={accInterest} onChange={e=>setAccInterest(e.target.value)} />
                                </div>
                                <div className="flex gap-3">
                                    {editingAcc && <button onClick={()=>requestDelete(editingAcc.id, 'account')} className="p-4 rounded-xl bg-rose-500/10 text-rose-500 hover:bg-rose-500/20"><Trash2 size={20}/></button>}
                                    <button onClick={handleSaveAccount} className={`flex-1 py-4 rounded-xl bg-gradient-to-r ${THEME.accentGradient} text-white font-bold shadow-lg active:scale-95 transition-transform`}>{editingAcc ? 'Update' : 'Save'}</button>
                                </div>
                            </>}
                            {modalMode === 'stocks' && <>
                                <h3 className={`text-center text-xs tracking-widest uppercase mb-6 ${THEME.textMuted}`}>{editingStock ? 'Edit Stock' : 'Add Stock'}</h3>
                                <div className="space-y-4 mb-6">
                                    <input className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} placeholder="Name (e.g. Maybank)" value={stockName} onChange={e=>setStockName(e.target.value)} />
                                    <input className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} placeholder="Symbol (e.g. 1155.KL)" value={stockSymbol} onChange={e=>setStockSymbol(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className={`text-[10px] uppercase ${THEME.textMuted}`}>Cost</label><input type="number" className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} value={stockCost} onChange={e=>setStockCost(e.target.value)} /></div>
                                        <div><label className={`text-[10px] uppercase ${THEME.textMuted}`}>Units</label><input type="number" className={`w-full p-4 rounded-xl outline-none ${THEME.inputBg} ${THEME.textMain}`} value={stockShares} onChange={e=>setStockShares(e.target.value)} /></div>
                                    </div>
                                    <div><label className={`text-[10px] uppercase ${THEME.textMuted}`}>Current Price</label><input type="number" className={`w-full p-4 rounded-xl outline-none border border-dashed border-white/20 ${THEME.inputBg} ${THEME.textMain}`} value={stockPrice} onChange={e=>setStockPrice(e.target.value)} /></div>
                                </div>
                                <div className="flex gap-3">
                                    {editingStock && <button onClick={()=>requestDelete(editingStock.id, 'stock')} className="p-4 rounded-xl bg-rose-500/10 text-rose-500 hover:bg-rose-500/20"><Trash2 size={20}/></button>}
                                    <button onClick={handleSaveStock} className={`flex-1 py-4 rounded-xl bg-gradient-to-r ${THEME.accentGradient} text-white font-bold shadow-lg active:scale-95 transition-transform`}>{editingStock ? 'Update' : 'Save'}</button>
                                </div>
                            </>}
                        </div>
                    </div>}

                    {/* SETTINGS MODAL */}
                    {showSettingsModal && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in" onClick={()=>setShowSettingsModal(false)}></div>
                        <div className={`w-full max-w-md rounded-3xl p-6 relative border shadow-2xl animate-in zoom-in-95 ${isDarkMode?'bg-[#1A1D2D] border-white/10':'bg-white border-slate-200'}`}>
                           <h3 className={`text-lg font-bold mb-4 ${THEME.textMain}`}>Settings</h3>
                           <div className="space-y-4">
                              {/* BACKUP & RESTORE */}
                              <div>
                                <label className={`text-xs font-bold uppercase mb-2 block ${THEME.textMuted}`}>Data Management</label>
                                <div className="flex gap-2">
                                    <button onClick={handleBackup} className={`flex-1 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 ${isDarkMode ? 'bg-white/5 hover:bg-white/10' : 'bg-slate-100 hover:bg-slate-200'} ${THEME.textMain}`}>
                                        <Download size={16} /> Backup
                                    </button>
                                    <input type="file" accept=".json" ref={fileInputRef} className="hidden" onChange={handleRestore} />
                                    <button onClick={() => fileInputRef.current.click()} className={`flex-1 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 ${isDarkMode ? 'bg-white/5 hover:bg-white/10' : 'bg-slate-100 hover:bg-slate-200'} ${THEME.textMain}`}>
                                        <Upload size={16} /> Restore
                                    </button>
                                </div>
                                <p className="text-[10px] text-gray-500 mt-2">Backup saves all your data (accounts, transactions, stocks) to a file. Restore loads that file.</p>
                              </div>

                              <div className="border-t border-white/5 pt-4">
                                <label className={`text-xs font-bold uppercase mb-1 block ${THEME.textMuted}`}>Gemini API Key</label>
                                <div className="flex gap-2">
                                    <div className={`flex items-center gap-2 p-3 rounded-xl flex-1 ${THEME.inputBg} ${keyStatus==='invalid' ? 'border border-rose-500/50' : keyStatus==='valid' ? 'border border-emerald-500/50' : ''}`}>
                                        <Key size={16} className={THEME.textMuted} />
                                        <input type="password" placeholder="Paste API Key Here" className={`bg-transparent w-full outline-none text-sm ${THEME.textMain}`} value={apiKey} onChange={e=>{setApiKey(e.target.value); setKeyStatus('none');}} />
                                    </div>
                                    <button onClick={verifyApiKey} disabled={!apiKey || keyStatus==='verifying'} className={`px-4 rounded-xl font-bold text-xs flex items-center gap-1 ${keyStatus==='valid' ? 'bg-emerald-500/10 text-emerald-500' : keyStatus==='invalid' ? 'bg-rose-500/10 text-rose-500' : isDarkMode?'bg-white/10':'bg-slate-200'}`}>
                                        {keyStatus === 'verifying' ? <RefreshCw size={14} className="animate-spin-slow"/> : keyStatus === 'valid' ? <ShieldCheck size={14}/> : keyStatus === 'invalid' ? <ShieldAlert size={14}/> : 'Verify'}
                                    </button>
                                </div>
                                <p className={`text-[10px] mt-1 transition-colors ${keyStatus==='valid'?'text-emerald-500':keyStatus==='invalid'?'text-rose-500':'text-gray-500'}`}>
                                    {keyStatus==='valid' ? 'API Key is active and working.' : keyStatus==='invalid' ? 'Invalid API Key. Please check and try again.' : 'Required for AI insights & stock updates.'}
                                </p>
                              </div>
                              
                              <button onClick={() => {
                                  if(confirm('Clear ALL data? This cannot be undone.')) {
                                      localStorage.clear();
                                      window.location.reload();
                                  }
                              }} className="w-full py-3 rounded-xl bg-rose-500/10 text-rose-500 font-bold text-sm mt-2">Reset All Data</button>
                           </div>
                        </div>
                    </div>}

                    {/* DELETE MODAL */}
                    {deleteTarget && <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={()=>setDeleteTarget(null)}></div>
                        <div className={`w-full max-w-xs rounded-2xl p-6 relative border shadow-2xl animate-in zoom-in-95 ${isDarkMode?'bg-[#1A1D2D] border-white/10':'bg-white border-slate-200'}`}>
                            <h3 className={`text-lg font-bold text-center mb-4 ${THEME.textMain}`}>Confirm Delete?</h3>
                            <div className="flex gap-3">
                                <button onClick={()=>setDeleteTarget(null)} className={`flex-1 py-3 rounded-xl font-bold text-sm ${isDarkMode?'bg-white/5':'bg-slate-100'}`}>Cancel</button>
                                <button onClick={confirmDelete} className="flex-1 py-3 rounded-xl bg-rose-500 text-white font-bold text-sm shadow-lg">Delete</button>
                            </div>
                        </div>
                    </div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script>
        // Check if sw.js actually exists before trying to register, or wrap in try/catch to silence errors in dev
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => { console.log('SW registered'); })
                    .catch(registrationError => { 
                        // Silently fail in dev/preview environments
                        console.log('SW registration skipped (likely dev environment)'); 
                    });
            });
        }
    </script>
</body>
</html>

